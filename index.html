<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atomic Ownership Lab - AOB 仿真实验室</title>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.run/@google/genai"
      }
    }
    </script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfcfd; color: #1e293b; overflow: hidden; height: 100vh; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .tab-content { display: none; height: calc(100vh - 280px); }
        .tab-content.active { display: flex; flex-direction: column; }
        
        .fixed-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: flex; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 100; }
        .fixed-overlay.open { opacity: 1; pointer-events: auto; }
        #details-overlay { justify-content: flex-end; }
        #details-content { width: 100%; max-width: 550px; height: 100%; background: white; box-shadow: -10px 0 30px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        #details-overlay.open #details-content { transform: translateX(0); }

        .btn-box { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; border: 2px solid transparent; }
        .btn-active { background-color: #4f46e5; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .btn-active:hover { background-color: #4338ca; }
        .btn-active:active { transform: scale(0.95); }
        .btn-inactive { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; opacity: 0.5; }
        
        .tab-btn { padding-top: 1rem; padding-bottom: 1rem; font-size: 0.875rem; font-weight: 700; border-bottom: 4px solid transparent; color: #94a3b8; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #4f46e5; color: #4f46e5; }

        .card { background-color: white; border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1rem; transition: all 0.2s; width: 12rem; flex-shrink: 0; cursor: pointer; position: relative; }
        .card:hover { border-color: #4f46e5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .chain-local { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .chain-remote { border-color: #f59e0b !important; background-color: #fffbeb !important; }
        .chain-mortgaged { border-color: #94a3b8 !important; border-style: dashed !important; opacity: 0.6; filter: grayscale(1); }
        .channel-local-tag { border-color: #4f46e5; background-color: #f5f3ff; }
        .channel-remote-tag { border-color: #f59e0b; background-color: #fffbeb; border-style: dashed; opacity: 0.7; }
        .channel-hybrid-tag { border-color: #10b981; background-color: #ecfdf5; border-width: 2px; }
        .local-badge { background: #4f46e5; color: white; padding: 1px 4px; border-radius: 3px; font-size: 7px; font-weight: 900; text-transform: uppercase; }

        #network-svg { width: 100%; height: 100%; background: #fff; }
        .node { stroke: #fff; stroke-width: 3px; cursor: pointer; transition: fill 0.3s; }
        .link { stroke: #cbd5e1; stroke-opacity: 0.6; stroke-width: 1.5px; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 p-8 z-30 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex justify-between items-start">
            <div class="space-y-2">
                <p class="text-xs font-black text-indigo-600 uppercase tracking-[0.3em]">Atomic Ownership Research Lab</p>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter">AOB 仿真实验室</h1>
                <div id="status-line" class="text-sm text-slate-500 font-bold leading-relaxed flex items-center gap-3">
                    <span>原子所有权 P2P 仿真环境。</span>
                    <div id="readiness-badges" class="flex gap-2"></div>
                </div>
            </div>
            <div id="mqtt-status" class="px-4 py-2 bg-amber-50 text-amber-600 text-[10px] font-black rounded-full uppercase border border-amber-100">Broker: Connecting...</div>
        </div>
        
        <div class="max-w-7xl mx-auto mt-8 flex flex-wrap gap-4 items-center">
            <button id="btn-init-net" onclick="window.initNetwork()" class="btn-box btn-active"><i data-lucide="network" size="18"></i> 建立网络</button>
            <button id="btn-init-accounts" onclick="window.initAccounts()" class="btn-box btn-inactive" disabled><i data-lucide="users" size="18"></i> 创建用户账户</button>
            <button id="btn-init-assets" onclick="window.initBanknotes()" class="btn-box btn-inactive" disabled><i data-lucide="banknote" size="18"></i> 创建区块链钞票</button>
            <button id="btn-init-channels" onclick="window.initChannels()" class="btn-box btn-inactive" disabled><i data-lucide="zap" size="18"></i> 建立快速通道</button>
        </div>
    </header>

    <nav class="bg-white border-b border-slate-100 px-8 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex gap-10">
            <button onclick="window.switchTab('nodes')" id="tab-btn-nodes" class="tab-btn active flex items-center gap-2">节点图谱 <i data-lucide="server" size="16"></i></button>
            <button onclick="window.switchTab('accounts')" id="tab-btn-accounts" class="tab-btn flex items-center gap-2">账户列表 <i data-lucide="user-square" size="16"></i></button>
            <button onclick="window.switchTab('chains')" id="tab-btn-chains" class="tab-btn flex items-center gap-2">钞票溯源 <i data-lucide="box" size="16"></i></button>
            <button onclick="window.switchTab('channels')" id="tab-btn-channels" class="tab-btn flex items-center gap-2">离线通道 <i data-lucide="zap" size="16"></i></button>
        </div>
    </nav>

    <main class="flex-grow bg-slate-50/50 relative overflow-hidden">
        <div id="tab-nodes" class="tab-content active overflow-hidden">
            <div class="flex-1 bg-white relative"><svg id="network-svg"></svg></div>
        </div>
        <div id="tab-accounts" class="tab-content p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-7xl mx-auto">
                <div id="account-grid-local" class="flex flex-wrap gap-6 mb-12"></div>
                <div id="account-grid-remote" class="flex flex-wrap gap-6"></div>
            </div>
        </div>
        <div id="tab-chains" class="tab-content p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-7xl mx-auto"><div id="chain-grid" class="flex flex-wrap gap-6"></div></div>
        </div>
        <div id="tab-channels" class="tab-content p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-7xl mx-auto"><div id="channel-grid" class="flex flex-wrap gap-6"></div></div>
        </div>
    </main>

    <div id="details-overlay" class="fixed-overlay" onclick="if(event.target==this) window.closeOverlay()">
        <div id="details-content" onclick="event.stopPropagation()">
            <div class="p-10 border-b border-slate-100 flex justify-between items-center">
                <h2 id="overlay-title" class="text-2xl font-black text-slate-900 uppercase">详情</h2>
                <button onclick="window.closeOverlay()" class="p-3 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div id="overlay-body" class="flex-1 overflow-y-auto custom-scrollbar p-10 space-y-8 pb-20"></div>
        </div>
    </div>

    <script>
        var mqttClient;
        var superUser = null;
        var appInstanceId = Math.random().toString(36).substr(2, 4).toUpperCase();
        var cascadeSession = { active: false, path: [], initiatorIdx: 0 }; 
        var currentOpenedChannelId = null;

        var simulationState = { 
            nodes: [], users: [], remoteUsers: [], 
            chains: [], speedyChannels: [], step: 0,
            processedIds: new Set(),
            pendingMortgages: [],
            activeAmount: 10,
            readyFlags: []
        };

        const CONFIG = {
            NODE_COUNT: 30, ACCOUNT_COUNT: 10, BANKNOTE_COUNT: 100,
            MQTT_BROKER: 'ws://test.mosquitto.org:8080', 
            TOPIC_MESH: 'aob/v25/global_mesh', TOPIC_DISCOVERY: 'aob/v25/discovery'
        };

        // --- Network Layer ---
        window.initNetwork = function() {
            const locals = Array.from({ length: CONFIG.NODE_COUNT }, (_, i) => ({
                id: `NODE-${appInstanceId}-${i}`, instance: appInstanceId, neighbors: [], logs: [], seenIds: new Set()
            }));
            simulationState.nodes = [...locals];
            locals.forEach(n => {
                while (n.neighbors.length < 4) {
                    const t = locals[Math.floor(Math.random() * locals.length)];
                    if (t.id !== n.id && !n.neighbors.includes(t.id) && t.neighbors.length < 7) {
                        n.neighbors.push(t.id); t.neighbors.push(n.id);
                    }
                    if (locals.every(an => an.neighbors.length >= 7 || an.id === n.id)) break;
                }
            });
            initNetworkViz();
            setInterval(() => {
                const ln = simulationState.nodes.filter(n => n.instance === appInstanceId);
                const rNode = ln[Math.floor(Math.random() * ln.length)];
                if (mqttClient && mqttClient.connected && rNode) {
                    mqttClient.publish(CONFIG.TOPIC_DISCOVERY, JSON.stringify({ type: 'HELLO', id: rNode.id, instance: appInstanceId }));
                }
            }, 3000);
            simulationState.readyFlags.push("网络就绪");
            simulationState.step = 1; updateStepUI(); window.switchTab('nodes');
        };

        window.initAccounts = async function() {
            superUser = await generateKeyPair(); simulationState.superUser = superUser;
            for (let i = 0; i < CONFIG.ACCOUNT_COUNT; i++) {
                const kp = await generateKeyPair(); 
                kp.nodes = [
                    `NODE-${appInstanceId}-${i * 3}`,
                    `NODE-${appInstanceId}-${i * 3 + 1}`,
                    `NODE-${appInstanceId}-${i * 3 + 2}`
                ];
                simulationState.users.push(kp);
            }
            simulationState.readyFlags.push("用户账户就绪");
            simulationState.step = 2; updateStepUI(); window.switchTab('accounts');
        };

        window.initBanknotes = async function() {
            const h = await getHash("AOB Definition Standard Document V1");
            for (let s = 1; s <= CONFIG.BANKNOTE_COUNT; s++) {
                const gData = `${h}\n${s}\n${superUser.pub}`; const gId = await getHash(gData);
                const genesis = { id: gId, type: 'GENESIS', data: gData, author: superUser.pub, chainRootId: gId };
                const target = simulationState.users[Math.floor(Math.random() * simulationState.users.length)];
                const payData = `PREV:${gId}\nTYPE:PAYMENT\nTARGET:${target.pub}\nTS:${Date.now()}`;
                const sig = await signData(payData, superUser.keyPair.privateKey);
                const payment = { id: sig, type: 'PAYMENT', data: payData, author: superUser.pub, target: target.pub, chainRootId: gId };
                updateGlobalState(genesis); updateGlobalState(payment);
                if (mqttClient && mqttClient.connected) {
                    mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block: genesis }));
                    mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block: payment }));
                }
            }
            simulationState.readyFlags.push("钞票就绪");
            simulationState.step = 3; updateStepUI(); window.switchTab('chains');
        };

        window.initChannels = async function() {
            const users = simulationState.users;
            for(let i=0; i<users.length; i++) {
                let currentCount = simulationState.speedyChannels.filter(c => c.participants.some(p => p.pub === users[i].pub)).length;
                let attempts = 0;
                
                const myNodes = simulationState.nodes.filter(n => users[i].nodes && users[i].nodes.includes(n.id));
                const remoteNeighbors = myNodes.flatMap(n => n.neighbors).filter(nbid => !nbid.includes(appInstanceId));
                
                if (remoteNeighbors.length > 0 && simulationState.remoteUsers.length > 0 && Math.random() > 0.5 && currentCount < 6) {
                    const remotes = [...simulationState.remoteUsers].sort(() => Math.random() - 0.5);
                    for (const rPub of remotes) {
                        const sortedPubs = [users[i].pub, rPub].sort();
                        if (!simulationState.speedyChannels.find(c => c.participants[0].pub === sortedPubs[0] && c.participants[1].pub === sortedPubs[1])) {
                            await createAndBroadcastChannel(users[i], { pub: rPub });
                            currentCount++;
                            break; 
                        }
                    }
                }

                while(currentCount < 6 && attempts < 80) {
                    const j = Math.floor(Math.random() * users.length);
                    if(i === j) { attempts++; continue; }
                    const u1 = users[i], u2 = users[j];
                    const sortedPubs = [u1.pub, u2.pub].sort();
                    if(!simulationState.speedyChannels.find(c => c.participants[0].pub === sortedPubs[0] && c.participants[1].pub === sortedPubs[1])) {
                        await createAndBroadcastChannel(u1, u2);
                        currentCount++;
                    }
                    attempts++;
                }
            }
            simulationState.readyFlags.push("快速通道就绪");
            simulationState.step = 4; updateStepUI(); window.switchTab('channels');
        };

        async function createAndBroadcastChannel(u1, u2) {
            const sorted = [u1.pub, u2.pub].sort();
            const rootData = `Speedy Channel\n${Date.now()}\n${sorted[0]}\n${u1.nodes?u1.nodes[0]:'EXT'}\n${sorted[1]}\n${u2.nodes?u2.nodes[0]:'EXT'}`;
            const cId = await getHash(rootData); 
            if (!simulationState.speedyChannels.find(x => x.id === cId)) {
                const block = { id: cId, type: 'SPEEDY_CHANNEL_ROOT', data: rootData, author: u1.pub, chainRootId: cId };
                updateGlobalState(block);
                if (mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block }));
                
                [u1, u2].forEach(async u => {
                    const localUser = simulationState.users.find(lu => lu.pub === u.pub);
                    if (localUser && localUser.keyPair) {
                        const chains = simulationState.chains.filter(c => c.currentOwner === u.pub && c.status === 'FREE')
                                         .sort((a, b) => b.denomination - a.denomination);
                        const chain = chains[0];
                        if(chain) {
                            const mData = `PREV:${chain.blocks[chain.blocks.length-1].id}\nTYPE:MORTGAGE\nTARGET:${cId}\nTS:${Date.now()}`;
                            const sig = await signData(mData, localUser.keyPair.privateKey);
                            const mBlock = { id: sig, type: 'MORTGAGE', data: mData, author: u.pub, target: cId, chainRootId: chain.genesisId };
                            updateGlobalState(mBlock);
                            if (mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block: mBlock }));
                        }
                    }
                });
            }
            return cId;
        }

        function updateGlobalState(block) {
            if (simulationState.processedIds.has(block.id)) return;
            simulationState.processedIds.add(block.id);

            const msgLogData = `Block:${block.type} ID:${block.id.slice(0,8)} Owner:${(block.target || block.author).slice(0,8)}`;
            simulationState.nodes.filter(n => n.instance === appInstanceId).forEach(n => {
                n.logs.unshift({ time: new Date().toLocaleTimeString(), type: block.type, data: msgLogData });
                if(n.logs.length > 50) n.logs.pop();
            });

            [block.author, block.target].forEach(p => {
                if (p && !simulationState.users.find(u => u.pub === p) && !simulationState.remoteUsers.includes(p)) {
                    simulationState.remoteUsers.push(p);
                }
            });

            let c = simulationState.chains.find(x => x.genesisId === block.chainRootId);
            if (block.type === 'GENESIS' && !c) {
                const parts = block.data.split('\n'); const s = +parts[1]; let d = 1; if(s>80) d=50; else if(s>60) d=20; else if(s>40) d=10; else if(s>20) d=5;
                c = { serial: s, denomination: d, genesisId: block.id, blocks: [block], currentOwner: 'SYSTEM', status: 'FREE' };
                simulationState.chains.push(c);
            } else if (c) {
                if (block.type === 'PAYMENT' && c.status === 'MORTGAGED') {
                    const chan = simulationState.speedyChannels.find(x => x.id === c.currentOwner);
                    if (chan) {
                        const p = chan.participants.find(p => p.pub === block.author);
                        if (p) p.balance -= c.denomination;
                    }
                }

                c.blocks.push(block);
                if (block.type === 'PAYMENT') { c.currentOwner = block.target; c.status = 'FREE'; }
                else if (block.type === 'MORTGAGE') {
                    c.status = 'MORTGAGED';
                    const ch = simulationState.speedyChannels.find(x=>x.id===block.target);
                    if(ch) {
                        const p = ch.participants.find(p=>p.pub===block.author);
                        if(p) p.balance += c.denomination;
                        c.currentOwner = block.target;
                    } else {
                        simulationState.pendingMortgages.push({ target: block.target, author: block.author, value: c.denomination, genesisId: c.genesisId });
                    }
                }
            }

            if (block.type === 'SPEEDY_CHANNEL_ROOT' && !simulationState.speedyChannels.find(x => x.id === block.id)) {
                const l = block.data.split('\n');
                const chan = { 
                    id: block.id, 
                    participants: [{pub:l[2], fp:l[2].slice(0,8), balance:0}, {pub:l[4], fp:l[4].slice(0,8), balance:0}],
                    history: [] 
                };
                simulationState.speedyChannels.push(chan);
                simulationState.pendingMortgages = simulationState.pendingMortgages.filter(pm => {
                    if (pm.target === block.id) {
                        const p = chan.participants.find(p => p.pub === pm.author);
                        if (p) p.balance += pm.value;
                        const chain = simulationState.chains.find(x => x.genesisId === pm.genesisId);
                        if (chain) chain.currentOwner = block.id;
                        return false;
                    }
                    return true;
                });
            }
            window.renderAll();
        }

        // --- P2P Logic ---
        function simulateFlood(originNodeId, content, type = 'TEST_MSG') {
            const mId = Math.random().toString(36).substr(2, 9);
            const msg = { mId, originator: originNodeId, fromNode: originNodeId, content, type, hop: 0, ts: Date.now() };
            if (mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ relay: msg }));
        }

        function handleIncomingRelay(msg) {
            simulationState.nodes.filter(n => n.instance === appInstanceId).forEach(n => {
                if (!n.seenIds.has(msg.mId)) {
                    if (n.neighbors.includes(msg.fromNode) || msg.originator === msg.fromNode) {
                        n.seenIds.add(msg.mId);
                        n.logs.unshift({ time: new Date().toLocaleTimeString(), type: msg.type, data: `[P2P] ${msg.content}` });
                        if (msg.hop < 4) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ relay: { ...msg, fromNode: n.id, hop: msg.hop + 1 } }));
                    }
                }
            });
        }

        // --- UI Rendering ---
        window.switchTab = function(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active');
                if(b.id === `tab-btn-${id}`) b.classList.add('active');
            });
            if(id === 'nodes' && simulation) updateNetworkViz();
            window.renderAll();
        };

        window.renderAll = function() {
            const lGrid = document.getElementById('account-grid-local'); if(lGrid) {
                lGrid.innerHTML = '';
                simulationState.users.forEach(u => {
                    const bal = simulationState.chains.filter(c => c.currentOwner === u.pub && c.status === 'FREE').reduce((s,c)=>s+c.denomination, 0);
                    const el = document.createElement('div'); el.className = 'card flex flex-col items-center gap-3';
                    el.onclick = () => window.openAccountOverlay(u.pub);
                    el.innerHTML = `<div class="p-3 bg-indigo-50 rounded-full text-indigo-600"><i data-lucide="user"></i></div><div class="text-sm font-black text-slate-800">$${bal}</div><div class="text-[9px] mono text-slate-400 font-bold">${u.fp}</div>`;
                    lGrid.appendChild(el);
                });
            }
            const rGrid = document.getElementById('account-grid-remote'); if(rGrid) {
                rGrid.innerHTML = '';
                simulationState.remoteUsers.forEach(pub => {
                    const el = document.createElement('div'); el.className = 'card flex flex-col items-center gap-3 opacity-60 grayscale scale-95';
                    el.onclick = () => window.openAccountOverlay(pub);
                    el.innerHTML = `<div class="p-3 bg-slate-100 rounded-full text-slate-400"><i data-lucide="user"></i></div><div class="text-xs font-bold text-slate-500">REMOTE</div><div class="text-[9px] mono text-slate-300 font-bold">${pub.slice(0,8)}</div>`;
                    rGrid.appendChild(el);
                });
            }
            const cGrid = document.getElementById('chain-grid'); if(cGrid) {
                cGrid.innerHTML = '';
                simulationState.chains.forEach(c => {
                    const isLocal = simulationState.users.some(u => u.pub === c.currentOwner);
                    const el = document.createElement('div');
                    let stateClass = c.status === 'MORTGAGED' ? "chain-mortgaged" : (isLocal ? "chain-local" : "chain-remote");
                    el.className = `card text-center ${stateClass}`;
                    el.onclick = () => window.openChainOverlay(c.genesisId);
                    el.innerHTML = `<div class="text-xl font-black chain-val">$${c.denomination}</div><div class="text-[9px] mono text-slate-500 font-bold mt-1 uppercase">ID: ${c.genesisId.slice(0,8)}</div>`;
                    cGrid.appendChild(el);
                });
            }
            const chGrid = document.getElementById('channel-grid'); if(chGrid) {
                chGrid.innerHTML = '';
                simulationState.speedyChannels.forEach(c => {
                    const isLocal1 = simulationState.users.some(u => u.pub === c.participants[0].pub);
                    const isLocal2 = simulationState.users.some(u => u.pub === c.participants[1].pub);
                    let type = (isLocal1 && isLocal2) ? "LOCAL" : (isLocal1 || isLocal2) ? "HYBRID" : "REMOTE";
                    let stateClass = (type === 'LOCAL') ? "channel-local-tag" : (type === 'HYBRID' ? "channel-hybrid-tag" : "channel-remote-tag");
                    const el = document.createElement('div'); el.className = `card ${stateClass}`;
                    el.onclick = () => window.openChannelOverlay(c.id);
                    el.innerHTML = `
                        <div class="text-[9px] font-black mb-2 uppercase tracking-tighter opacity-70">${type} CHANNEL</div>
                        <div class="flex justify-between items-center text-xs">
                            <div class="text-center font-bold"><div>$${c.participants[0].balance}</div><div class="text-[8px] opacity-60">${c.participants[0].fp} ${isLocal1?'<span class="local-badge">L</span>':''}</div></div>
                            <i data-lucide="zap" class="opacity-40" size="14"></i>
                            <div class="text-center font-bold"><div>$${c.participants[1].balance}</div><div class="text-[8px] opacity-60">${c.participants[1].fp} ${isLocal2?'<span class="local-badge">L</span>':''}</div></div>
                        </div>
                        <div class="text-[8px] mono opacity-40 mt-3 pt-2 border-t border-slate-100 truncate">ID: ${c.id.slice(0,16)}...</div>
                    `;
                    chGrid.appendChild(el);
                });
            }
            if(window.lucide) lucide.createIcons();
            
            // 刷新就绪状态栏
            const badgeContainer = document.getElementById('readiness-badges');
            if (badgeContainer) {
                badgeContainer.innerHTML = simulationState.readyFlags.map(f => `<span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded text-[10px] uppercase font-black tracking-widest">${f}</span>`).join(' · ');
            }
        };

        window.openNodeOverlay = function(id) {
            const n = simulationState.nodes.find(x => x.id === id);
            if(!n) return;
            const boundUsers = simulationState.users.filter(u => u.nodes && u.nodes.includes(id));
            window.openOverlay(`节点控制台: ${id}`);
            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6">
                    <div class="p-6 bg-slate-900 rounded-[2rem] text-white shadow-xl border-4 border-indigo-900/30">
                        <div class="text-[10px] uppercase font-black tracking-widest text-indigo-400 mb-3">关联账户</div>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${boundUsers.map(u => `<div class="text-[9px] mono bg-indigo-500/20 px-3 py-1.5 rounded-lg border border-indigo-500/40 font-black">${u.fp}</div>`).join('') || '<div class="text-xs italic text-slate-500">无直接关联账户</div>'}
                        </div>
                        <div class="text-[10px] uppercase font-black tracking-widest text-indigo-400 mb-3">邻居连接 (${n.neighbors.length})</div>
                        <div class="flex flex-wrap gap-2">
                            ${n.neighbors.map(nb => `<button onclick="window.openNodeOverlay('${nb}')" class="text-[9px] mono bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">${nb}</button>`).join('') || '<div class="text-xs italic text-slate-500">孤立中</div>'}
                        </div>
                    </div>
                    <div class="p-8 bg-indigo-50 border-2 border-indigo-100 rounded-[2rem] space-y-4 shadow-inner">
                        <h4 class="text-[10px] font-black uppercase text-indigo-600 tracking-widest flex items-center gap-2"><i data-lucide="radio" size="14"></i> 广播测试</h4>
                        <div class="flex gap-2">
                            <input id="node-test-input" type="text" placeholder="输入测试消息..." class="flex-1 bg-white p-3 rounded-xl text-xs font-bold outline-none ring-1 ring-slate-200">
                            <button onclick="window.broadcastTest('${id}')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-md active:scale-95">广播</button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">实时接收记录 (TOP 50)</h4>
                        <div class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
                            ${n.logs.map(l => `<div class="p-4 border bg-white rounded-2xl flex flex-col gap-1 shadow-sm"><div class="flex justify-between items-center"><span class="text-[8px] font-black bg-slate-100 px-2 py-0.5 rounded text-slate-500 uppercase">${l.type}</span><span class="text-[8px] font-bold text-slate-400 mono">${l.time}</span></div><div class="text-[10px] font-bold text-slate-700 break-all leading-relaxed">${l.data}</div></div>`).join('') || '<div class="text-xs text-slate-300 italic text-center py-8">暂无消息流。</div>'}
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        };

        window.broadcastTest = (nid) => {
            const input = document.getElementById('node-test-input');
            if(!input.value) return;
            simulateFlood(nid, input.value);
            input.value = '';
            window.openNodeOverlay(nid);
        };

        window.openAccountOverlay = function(pub) {
            const isLocal = simulationState.users.some(u => u.pub === pub);
            const user = isLocal ? simulationState.users.find(u => u.pub === pub) : { pub };
            const owned = simulationState.chains.filter(c => c.currentOwner === pub);
            const participated = simulationState.speedyChannels.filter(c => c.participants.some(p => p.pub === pub));
            window.openOverlay(isLocal ? "本地账户" : "同步远端账户");
            
            let extra = '';
            if(isLocal) {
                const targets = [...simulationState.users.filter(u=>u.pub!==pub).map(u=>({pub:u.pub, label:'LOCAL'})), ...simulationState.remoteUsers.map(r=>({pub:r, label:'REMOTE'}))];
                extra = `
                    <div class="p-8 bg-slate-900 rounded-[2rem] text-white shadow-xl space-y-4">
                        <h4 class="text-[10px] font-black uppercase text-indigo-400 tracking-widest">绑定节点</h4>
                        <div class="flex flex-wrap gap-2">
                            ${user.nodes.map(nid => `<button onclick="window.openNodeOverlay('${nid}')" class="text-[9px] mono bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">${nid}</button>`).join('')}
                        </div>
                    </div>
                    <div class="p-8 bg-indigo-50 border-2 border-indigo-100 rounded-[2rem] space-y-4">
                        <h4 class="text-[10px] font-black uppercase text-indigo-600 tracking-widest">创建跨实例 Speedy Channel</h4>
                        <select id="manual-ch-target" class="w-full bg-white p-3 rounded-xl text-[10px] mono outline-none ring-1 ring-slate-200">
                            ${targets.map(t => `<option value="${t.pub}">${t.pub.slice(0,16)}... (${t.label})</option>`).join('') || '<option disabled>无可用对象</option>'}
                        </select>
                        <button onclick="window.execManualChannel('${pub}')" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg active:scale-95">签署根区块广播</button>
                    </div>
                `;
            }

            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6">
                    <div class="p-10 ${isLocal?'bg-indigo-600':'bg-slate-600'} text-white rounded-[2.5rem] text-center shadow-xl">
                        <div class="text-[10px] opacity-60 font-black tracking-widest mb-2 uppercase">流动资产</div>
                        <div class="text-6xl font-black">$${owned.filter(c=>c.status==='FREE').reduce((s,c)=>s+c.denomination,0)}</div>
                        <div class="mt-6 text-[9px] mono opacity-60 break-all select-all font-bold">${pub}</div>
                    </div>
                    ${extra}
                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">所属通道列表</h4>
                        <div class="space-y-2">
                            ${participated.map(c => `<div onclick="window.openChannelOverlay('${c.id}')" class="p-4 border bg-white rounded-2xl flex justify-between items-center cursor-pointer hover:border-indigo-300 shadow-sm"><div class="text-[10px] font-bold text-slate-700">ID: ${c.id.slice(0,8)}...</div><div class="text-[10px] font-black text-indigo-600">$${c.participants.find(p=>p.pub===pub).balance}</div></div>`).join('') || '<div class="text-xs text-slate-300 italic py-4 text-center">暂无活动通道</div>'}
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        };

        window.execManualChannel = async function(localPub) {
            const targetPub = document.getElementById('manual-ch-target').value;
            const u1 = simulationState.users.find(u => u.pub === localPub);
            const u2 = simulationState.users.find(u => u.pub === targetPub) || { pub: targetPub };
            const cId = await createAndBroadcastChannel(u1, u2);
            alert(`跨实例通道建立成功！\nID: ${cId.slice(0,12)}...`);
            window.closeOverlay(); window.switchTab('channels');
        };

        window.openChannelOverlay = function(id) {
            currentOpenedChannelId = id;
            cascadeSession = { active: false, path: [id], initiatorIdx: 0 };
            window.refreshChannelUI(id);
        };

        window.refreshChannelUI = function(id) {
            const chan = simulationState.speedyChannels.find(x => x.id === id);
            if (!chan) return;
            const p1 = chan.participants[0], p2 = chan.participants[1];
            const isP1Local = simulationState.users.some(u => u.pub === p1.pub);
            const isP2Local = simulationState.users.some(u => u.pub === p2.pub);
            const mortgagedBanknotes = simulationState.chains.filter(c => c.currentOwner === id && c.status === 'MORTGAGED');

            window.openOverlay(`Speedy Channel 面板`);
            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6 pb-20">
                    <div class="p-12 bg-slate-900 rounded-[3.5rem] flex justify-between items-center text-white shadow-2xl border-4 border-indigo-900/30">
                        <div class="text-center flex-1">
                            <div class="text-5xl font-black">$${p1.balance}</div>
                            <div class="text-[9px] mono text-indigo-400 mt-2 font-bold">${p1.fp} ${isP1Local?'<span class="local-badge">L</span>':''}</div>
                        </div>
                        <i data-lucide="zap" class="text-emerald-500 animate-pulse" size="40"></i>
                        <div class="text-center flex-1">
                            <div class="text-5xl font-black">$${p2.balance}</div>
                            <div class="text-[9px] mono text-indigo-400 mt-2 font-bold">${p2.fp} ${isP2Local?'<span class="local-badge">L</span>':''}</div>
                        </div>
                    </div>
                    <div class="p-8 bg-white border-2 border-indigo-50 rounded-[2.5rem] space-y-6 shadow-lg">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">离线支付</h4>
                        <div class="flex gap-4">
                            <select id="ch-sender" class="flex-1 bg-slate-50 p-4 rounded-xl text-xs font-black outline-none"><option value="0" ${!isP1Local ? 'disabled' : ''}>${p1.fp} 发送</option><option value="1" ${!isP2Local ? 'disabled' : ''}>${p2.fp} 发送</option></select>
                            <input id="ch-amt" type="number" oninput="simulationState.activeAmount = Number(this.value)" class="w-24 bg-slate-50 p-4 rounded-xl text-xs font-black outline-none" value="${simulationState.activeAmount}">
                        </div>
                        <div class="grid grid-cols-2 gap-4"><button onclick="window.execChPay('${id}')" class="bg-indigo-600 text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg">直接支付</button><button onclick="window.startCascadeMode('${id}')" class="bg-indigo-50 text-indigo-600 py-4 rounded-xl font-black text-[10px] uppercase">开启级联</button></div>
                    </div>
                    
                    <div id="cascade-builder" class="${cascadeSession.active ? '' : 'hidden'} p-8 bg-indigo-50/50 rounded-[3rem] space-y-4 border-4 border-white shadow-inner">
                        <h4 class="text-[11px] font-black uppercase text-indigo-600 tracking-widest flex items-center gap-2">原子级联路径</h4>
                        <div id="cascade-steps" class="space-y-2"></div><div id="cascade-next" class="pt-4 border-t border-indigo-100"></div>
                        <button onclick="window.executeCascade()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase text-xs shadow-xl mt-4">同步全网级联结果</button>
                    </div>

                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">通道中抵押的区块链钞票</h4>
                        <div class="space-y-2">
                            ${mortgagedBanknotes.map(c => `
                                <div class="p-4 bg-white border-2 border-slate-100 rounded-2xl flex justify-between items-center shadow-sm">
                                    <div class="flex flex-col">
                                        <div class="text-sm font-black text-slate-700">$${c.denomination}</div>
                                        <div class="text-[8px] mono text-slate-400 font-bold uppercase">ID: ${c.genesisId.slice(0,12)}...</div>
                                    </div>
                                    <button onclick="window.execWithdraw('${c.genesisId}', '${id}')" class="bg-indigo-100 text-indigo-600 px-4 py-2 rounded-lg text-[10px] font-black uppercase hover:bg-indigo-200 transition-colors">提现</button>
                                </div>
                            `).join('') || '<div class="text-xs text-slate-300 italic text-center py-6">当前无抵押资产</div>'}
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">通道支付记录</h4>
                        <div class="space-y-2">
                            ${(chan.history || []).map(h => `
                                <div class="p-4 bg-slate-50 border border-slate-100 rounded-2xl flex justify-between items-center">
                                    <div class="flex items-center gap-3">
                                        <span class="mono text-[10px] font-black text-indigo-600">${h.senderFp}</span>
                                        <i data-lucide="arrow-right" size="10" class="text-slate-300"></i>
                                        <span class="mono text-[10px] font-black text-emerald-600">${h.receiverFp}</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-[10px] font-black text-slate-700">$${h.amount}</span>
                                        <span class="text-[8px] mono text-slate-400">${h.time}</span>
                                    </div>
                                </div>
                            `).reverse().join('') || '<div class="text-xs text-slate-300 italic text-center py-6">暂无支付记录</div>'}
                        </div>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
            if(cascadeSession.active) window.updateCascadeList();
        };

        window.execWithdraw = async function(genesisId, channelId) {
            const c = simulationState.chains.find(x => x.genesisId === genesisId);
            const chan = simulationState.speedyChannels.find(x => x.id === channelId);
            const localParticipant = chan.participants.find(p => simulationState.users.some(u => u.pub === p.pub));
            if (!localParticipant) { alert("无本地参与者，无法执行提现。"); return; }
            if (localParticipant.balance < c.denomination) { alert(`余额不足，无法提取 $${c.denomination}（余额 $${localParticipant.balance}）。`); return; }

            const localUser = simulationState.users.find(u => u.pub === localParticipant.pub);
            const data = `PREV:${c.blocks[c.blocks.length-1].id}\nTYPE:PAYMENT\nTARGET:${localParticipant.pub}\nTS:${Date.now()}`;
            const sig = await signData(data, localUser.keyPair.privateKey);
            const block = { id: sig, type: 'PAYMENT', data, author: localParticipant.pub, target: localParticipant.pub, chainRootId: genesisId };
            
            updateGlobalState(block);
            if(mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block }));
            alert(`提现成功。`); window.refreshChannelUI(channelId);
        };

        window.startCascadeMode = (id) => { cascadeSession.active = true; cascadeSession.initiatorIdx = +document.getElementById('ch-sender').value; cascadeSession.path = [id]; window.refreshChannelUI(id); };
        window.updateCascadeList = () => {
            const stepsEl = document.getElementById('cascade-steps');
            const nextEl = document.getElementById('cascade-next');
            if(!stepsEl) return;
            
            let currentPathPub = simulationState.speedyChannels.find(x => x.id === cascadeSession.path[0]).participants[cascadeSession.initiatorIdx].pub;
            stepsEl.innerHTML = cascadeSession.path.map((cid, i) => {
                const chan = simulationState.speedyChannels.find(x => x.id === cid);
                const sender = chan.participants.find(p => p.pub === currentPathPub);
                const receiver = chan.participants.find(p => p.pub !== currentPathPub);
                const html = `
                    <div class="p-4 bg-white rounded-2xl text-[10px] border-2 border-indigo-100 flex flex-col gap-1 shadow-sm">
                        <div class="flex justify-between font-black text-indigo-600 uppercase">
                            <span>Hop #${i+1}</span>
                            <span class="mono">ID: ${cid.slice(0,8)}...</span>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="mono px-2 py-0.5 bg-indigo-50 rounded text-slate-700 font-bold">${sender.fp}</span>
                            <i data-lucide="arrow-right" size="10" class="text-slate-300"></i>
                            <span class="mono px-2 py-0.5 bg-emerald-50 rounded text-slate-700 font-bold">${receiver.fp}</span>
                        </div>
                    </div>`;
                currentPathPub = receiver.pub; 
                return html;
            }).join('');
            
            const others = simulationState.speedyChannels.filter(c => !cascadeSession.path.includes(c.id) && c.participants.some(p => p.pub === currentPathPub));
            nextEl.innerHTML = others.map(o => {
                const partner = o.participants.find(p => p.pub !== currentPathPub);
                const selfBal = o.participants.find(p => p.pub === currentPathPub).balance;
                return `<button onclick="window.addCascadeHop('${o.id}')" class="w-full bg-white p-4 rounded-2xl text-[10px] text-indigo-700 text-left border-2 border-dashed border-indigo-200 hover:border-indigo-400 flex justify-between items-center transition-all"><div class="flex justify-between items-center w-full"><div class="space-y-1"><span class="font-black">转发至 ${partner.fp}</span><div class="text-[8px] opacity-60">余额: ${selfBal} -> ${partner.balance}</div></div><i data-lucide="plus" size="14"></i></div></button>`;
            }).join('') || '<div class="text-xs italic text-slate-400 text-center py-4">无更多下游通道。</div>';
            if(window.lucide) lucide.createIcons();
        };
        window.addCascadeHop = (id) => { cascadeSession.path.push(id); window.updateCascadeList(); };
        
        window.executeCascade = () => {
            const amt = Number(simulationState.activeAmount);
            if (isNaN(amt) || amt <= 0) { alert("金额无效。"); return; }
            let currentPathPub = simulationState.speedyChannels.find(x => x.id === cascadeSession.path[0]).participants[cascadeSession.initiatorIdx].pub;
            for(const cid of cascadeSession.path) {
                const c = simulationState.speedyChannels.find(x => x.id === cid);
                const sIdx = c.participants.findIndex(p => p.pub === currentPathPub);
                if (c.participants[sIdx].balance < amt) { alert(`通道 ${cid.slice(0,8)} 余额不足。`); return; }
                currentPathPub = c.participants[sIdx === 0 ? 1 : 0].pub;
            }
            currentPathPub = simulationState.speedyChannels.find(x => x.id === cascadeSession.path[0]).participants[cascadeSession.initiatorIdx].pub;
            cascadeSession.path.forEach(cid => {
                const c = simulationState.speedyChannels.find(x => x.id === cid);
                if(mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ type: 'SPEEDY_CHANNEL_UPDATE', msgId: Math.random().toString(36).substr(2, 9), channelId: cid, senderPub: currentPathPub, senderInstance: appInstanceId, amount: amt }));
                currentPathPub = c.participants.find(p => p.pub !== currentPathPub).pub;
            });
            alert(`原子级联同步完成。`); cascadeSession.active = false; window.closeOverlay();
        };

        window.execChPay = (id) => {
            const c = simulationState.speedyChannels.find(x=>x.id===id);
            const sIdx = +document.getElementById('ch-sender').value;
            const amt = Number(simulationState.activeAmount);
            if (isNaN(amt) || amt <= 0) return;
            if(c.participants[sIdx].balance >= amt) {
                if(mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ type: 'SPEEDY_CHANNEL_UPDATE', msgId: Math.random().toString(36).substr(2, 9), channelId: id, senderPub: c.participants[sIdx].pub, senderInstance: appInstanceId, amount: amt }));
            } else alert("余额不足。");
        };

        window.openChainOverlay = function(id) {
            const c = simulationState.chains.find(x => x.genesisId === id);
            const isLocal = simulationState.users.some(u => u.pub === c.currentOwner);
            window.openOverlay(`钞票溯源: ${id.slice(0,12)}`);
            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6">
                    <div class="p-10 bg-emerald-50 border-4 border-emerald-100 rounded-[3rem] text-center"><div class="text-7xl font-black text-emerald-600">$${c.denomination}</div><div class="text-[10px] font-black uppercase text-slate-400 mt-4 tracking-widest">STATUS: ${c.status}</div></div>
                    ${isLocal && c.status === 'FREE' ? `<div class="p-8 bg-white border-2 border-indigo-50 rounded-[2.5rem] space-y-5 shadow-lg"><h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">签署支付区块</h4><select id="pay-target-select" class="w-full bg-slate-50 p-4 rounded-xl text-[10px] mono border-none outline-none ring-1 ring-slate-200"><optgroup label="远端同步账户">${simulationState.remoteUsers.map(u => `<option value="${u}">${u.slice(0,16)}...</option>`).join('')}</optgroup><optgroup label="本地账户">${simulationState.users.filter(u=>u.pub !== c.currentOwner).map(u => `<option value="${u.pub}">${u.fp}</option>`).join('')}</optgroup></select><button onclick="window.execPayment('${id}')" class="w-full bg-indigo-600 text-white py-5 rounded-xl font-black uppercase text-xs shadow-xl active:scale-95">全网广播区块</button></div>` : `<div class="p-10 bg-slate-100 rounded-[2.5rem] text-center text-xs text-slate-400 italic">当前非持有者。</div>`}
                </div>
            `;
        };
        window.execPayment = async function(chainId) {
            const c = simulationState.chains.find(x => x.genesisId === chainId);
            const target = document.getElementById('pay-target-select').value;
            const owner = simulationState.users.find(u => u.pub === c.currentOwner);
            const data = `PREV:${c.blocks[c.blocks.length-1].id}\nTYPE:PAYMENT\nTARGET:${target}\nTS:${Date.now()}`;
            const sig = await signData(data, owner.keyPair.privateKey);
            const block = { id: sig, type: 'PAYMENT', data, author: c.currentOwner, target, chainRootId: chainId };
            updateGlobalState(block); if(mqttClient) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block }));
            window.closeOverlay();
        };

        window.openOverlay = (t) => { document.getElementById('overlay-title').innerText = t; document.getElementById('details-overlay').classList.add('open'); };
        window.closeOverlay = () => { currentOpenedChannelId = null; document.getElementById('details-overlay').classList.remove('open'); window.renderAll(); };
        
        async function getHash(text) {
            const hashBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
            return btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
        }
        
        async function generateKeyPair() { 
            const kp = await crypto.subtle.generateKey({ name: "ECDSA", namedCurve: "P-256" }, true, ["sign", "verify"]); 
            const rawPub = await crypto.subtle.exportKey("raw", kp.publicKey); 
            const pub = btoa(String.fromCharCode(...new Uint8Array(rawPub))); 
            return { pub, fp: pub.slice(0, 8), keyPair: kp }; 
        }
        async function signData(d, pk) { const s = await crypto.subtle.sign({ name: "ECDSA", hash: { name: "SHA-256" } }, pk, new TextEncoder().encode(d)); return btoa(String.fromCharCode(...new Uint8Array(s))); }

        // --- Visualizer ---
        let simulation, svg, g;
        function initNetworkViz() {
            svg = d3.select("#network-svg"); if(!svg.node()) return;
            const w = svg.node().getBoundingClientRect().width, h = svg.node().getBoundingClientRect().height;
            g = svg.append("g"); svg.call(d3.zoom().scaleExtent([0.1, 5]).on("zoom", (e) => g.attr("transform", e.transform)));
            simulation = d3.forceSimulation().force("link", d3.forceLink().id(d => d.id).distance(150)).force("charge", d3.forceManyBody().strength(-400)).force("center", d3.forceCenter(w/2, h/2));
            updateNetworkViz();
        }
        function updateNetworkViz() {
            if(!g) return;
            const nodes = simulationState.nodes.map(n => ({ id: n.id, local: n.instance === appInstanceId }));
            const links = []; 
            simulationState.nodes.forEach(n => { n.neighbors.forEach(nbid => { if (n.id < nbid && simulationState.nodes.some(x => x.id === nbid)) links.push({ source: n.id, target: nbid }); }); });
            g.selectAll("*").remove();
            const link = g.append("g").selectAll("line").data(links).enter().append("line").attr("class", "link");
            const node = g.append("g").selectAll("circle").data(nodes).enter().append("circle").attr("r", 12).attr("fill", d => d.local ? "#4f46e5" : "#fb923c").attr("class", "node shadow-lg").on("click", (e, d) => window.openNodeOverlay(d.id));
            simulation.nodes(nodes); simulation.force("link").links(links); simulation.alpha(1).restart();
            simulation.on("tick", () => { link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y); node.attr("cx", d => d.x).attr("cy", d => d.y); });
        }
        function updateStepUI() {
            const steps = [
                { id: 'btn-init-net', index: 0 },
                { id: 'btn-init-accounts', index: 1 },
                { id: 'btn-init-assets', index: 2 },
                { id: 'btn-init-channels', index: 3 }
            ];
            steps.forEach(s => {
                const btn = document.getElementById(s.id);
                if (!btn) return;
                if (simulationState.step > s.index) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'flex';
                    btn.disabled = simulationState.step !== s.index;
                    if (simulationState.step === s.index) {
                        btn.classList.add('btn-active'); btn.classList.remove('btn-inactive');
                    } else {
                        btn.classList.remove('btn-active'); btn.classList.add('btn-inactive');
                    }
                }
            });
            window.renderAll();
        }

        // --- MQTT ---
        try {
            mqttClient = mqtt.connect(CONFIG.MQTT_BROKER, { clientId: 'aob_v25_' + appInstanceId, clean: true });
            mqttClient.on('connect', () => { 
                mqttClient.subscribe(CONFIG.TOPIC_MESH); 
                mqttClient.subscribe(CONFIG.TOPIC_DISCOVERY); 
                const statusEl = document.getElementById('mqtt-status');
                statusEl.innerText = "Broker: Online"; 
                statusEl.className = "px-4 py-2 bg-green-50 text-green-600 text-[10px] font-black rounded-full uppercase border border-green-100";
            });
            mqttClient.on('message', (t, p) => {
                try {
                    const d = JSON.parse(p.toString());
                    if (t === CONFIG.TOPIC_DISCOVERY) {
                        if (d.instance === appInstanceId) return;
                        let rNode = simulationState.nodes.find(x => x.id === d.id);
                        if (!rNode) {
                            rNode = { id: d.id, instance: d.instance, neighbors: [], logs: [], seenIds: new Set() };
                            simulationState.nodes.push(rNode);
                            const locals = simulationState.nodes.filter(n => n.instance === appInstanceId && n.neighbors.length < 7);
                            if(locals.length > 0) locals.sort(() => Math.random() - 0.5).slice(0, 2).forEach(ln => { if(!ln.neighbors.includes(d.id)) { ln.neighbors.push(d.id); rNode.neighbors.push(ln.id); } });
                            if(simulation) updateNetworkViz();
                        }
                    } else if (t === CONFIG.TOPIC_MESH) {
                        if (d.relay) handleIncomingRelay(d.relay);
                        else if (d.block) updateGlobalState(d.block);
                        else if (d.type === 'SPEEDY_CHANNEL_UPDATE') {
                            if(simulationState.processedIds.has(d.msgId)) return;
                            simulationState.processedIds.add(d.msgId);
                            const c = simulationState.speedyChannels.find(x => x.id === d.channelId);
                            if (c) {
                                const sIdx = c.participants.findIndex(p => p.pub === d.senderPub);
                                if (sIdx !== -1) {
                                    const rIdx = sIdx === 0 ? 1 : 0;
                                    const amount = Number(d.amount); 
                                    c.participants[sIdx].balance -= amount;
                                    c.participants[rIdx].balance += amount;
                                    if(!c.history) c.history = [];
                                    c.history.push({ time: new Date().toLocaleTimeString(), senderFp: c.participants[sIdx].fp, receiverFp: c.participants[rIdx].fp, amount: amount });
                                }
                                window.renderAll();
                                if(currentOpenedChannelId && (currentOpenedChannelId === d.channelId || (cascadeSession.active && cascadeSession.path.includes(d.channelId)))) window.refreshChannelUI(cascadeSession.active ? cascadeSession.path[0] : currentOpenedChannelId);
                            }
                        }
                    }
                } catch (e) {}
            });
        } catch (e) {}
        document.addEventListener('DOMContentLoaded', updateStepUI);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atomic MESH - AOB 实验室</title>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        :root { --accent: #4f46e5; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfcfd; color: #1e293b; overflow: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .node-pulse { animation: pulse-bg 0.6s ease-out; }
        @keyframes pulse-bg { 0% { background-color: rgba(79, 70, 229, 0.4); border-color: #4f46e5; } 100% { background-color: white; border-color: #e2e8f0; } }
        
        /* 强化手形指针 */
        [onclick], button, select, .card, .tab-btn, a { cursor: pointer !important; }
        
        .btn-active { @apply bg-indigo-600 text-white shadow-md hover:bg-indigo-700; }
        .btn-inactive { @apply bg-slate-100 text-slate-400 cursor-not-allowed; }
        .card { @apply bg-white border border-slate-200 rounded-xl p-4 transition-all hover:shadow-md hover:border-indigo-300; }
        
        .log-entry { transition: all 0.3s ease; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 p-6 z-30">
        <div class="max-w-7xl mx-auto">
            <div id="intro-text" class="mb-6 space-y-1">
                <p class="text-sm font-semibold text-indigo-600 uppercase tracking-wider">AOB Protocol Simulation</p>
                <h1 class="text-2xl font-extrabold text-slate-900">Atomic Ownership Blockchains 仿真实验室</h1>
                <div id="status-history" class="text-xs text-slate-500 font-medium leading-relaxed">提示：本项目演示 AOB 原子所有权协议。请点击“建立网络”开始。</div>
            </div>
            
            <div id="controls" class="flex flex-wrap gap-3">
                <button id="btn-init-net" onclick="initNetwork()" class="px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition-all"><i data-lucide="network" size="16"></i> 建立网络</button>
                <button id="btn-init-users" onclick="initUsers()" class="px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition-all btn-inactive" disabled><i data-lucide="users" size="16"></i> 创建用户账户</button>
                <button id="btn-init-assets" onclick="initBanknotes()" class="px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition-all btn-inactive" disabled><i data-lucide="banknote" size="16"></i> 创建区块链钞票</button>
                <button id="btn-init-channels" class="px-5 py-2.5 rounded-xl font-bold text-sm flex items-center gap-2 transition-all btn-inactive" disabled><i data-lucide="zap" size="16"></i> 建立快速通道</button>
            </div>
        </div>
    </header>

    <nav class="bg-white border-b border-slate-100 px-6">
        <div class="max-w-7xl mx-auto flex gap-8">
            <button onclick="switchTab('nodes')" id="tab-btn-nodes" class="tab-btn py-4 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 flex items-center gap-2"><i data-lucide="server" size="14"></i> 节点</button>
            <button onclick="switchTab('users')" id="tab-btn-users" class="tab-btn py-4 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 flex items-center gap-2"><i data-lucide="user-square" size="14"></i> 用户</button>
            <button onclick="switchTab('chains')" id="tab-btn-chains" class="tab-btn py-4 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 flex items-center gap-2"><i data-lucide="box" size="14"></i> 区块链</button>
            <button onclick="switchTab('channels')" id="tab-btn-channels" class="tab-btn py-4 text-sm font-bold border-b-2 border-transparent text-slate-400 hover:text-slate-600 flex items-center gap-2"><i data-lucide="git-branch" size="14"></i> 通道</button>
        </div>
    </nav>

    <main class="flex-1 overflow-hidden relative bg-slate-50/50">
        <div id="tab-nodes" class="tab-content active h-full p-8 overflow-y-auto custom-scrollbar">
            <div id="node-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-10 gap-4 max-w-7xl mx-auto"></div>
        </div>
        <div id="tab-users" class="tab-content h-full p-8 overflow-y-auto custom-scrollbar">
            <div id="user-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 max-w-7xl mx-auto"></div>
        </div>
        <div id="tab-chains" class="tab-content h-full p-8 overflow-y-auto custom-scrollbar">
            <div id="chain-grid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-8 xl:grid-cols-10 gap-4 max-w-7xl mx-auto"></div>
        </div>
        <div id="tab-channels" class="tab-content h-full p-8 flex items-center justify-center text-slate-300 font-bold uppercase tracking-widest italic">
            Experimental Feature: Fast Channels (Coming Soon)
        </div>
    </main>

    <div id="overlay" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-50 flex justify-end transition-opacity opacity-0 pointer-events-none">
        <div id="overlay-content" class="w-full max-w-lg bg-white h-full shadow-2xl flex flex-col p-10 transform translate-x-full transition-transform duration-300">
            <div class="flex justify-between items-center mb-8">
                <h2 id="overlay-title" class="text-xl font-extrabold text-slate-900 uppercase tracking-tight">详情</h2>
                <button onclick="closeOverlay()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div id="overlay-body" class="flex-1 overflow-y-auto custom-scrollbar space-y-6"></div>
        </div>
    </div>

    <script>
        const CONFIG = {
            NODE_COUNT: 30,
            USER_COUNT: 30,
            BANKNOTE_COUNT: 100,
            SYNC_KEY: 'aob_v7_mesh',
            DEFINITION_DOC: `Define each blockchain as a banknote, with the data structure of its genesis block as: H\\nS\\nK, where: H is the SHA256 hash of this document (Base64); K is the public key of the super user (Base64), fixed at [超级用户的公钥]; S is the serial number, with the following correspondence to the banknote's denomination:
1-20 1
21-40 5
41-60 10
61-80 20
81-100 50`
        };

        // --- State ---
        let state = {
            nodes: [],
            users: [], 
            chains: [],
            step: 0,
            globalSeen: new Set()
        };

        let activeOverlayId = null;
        let superUser = null;
        const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
        const db = gun.get(CONFIG.SYNC_KEY);

        // --- Crypto & Utils ---
        async function getHash(text) {
            const msgUint8 = new TextEncoder().encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
            return btoa(String.fromCharCode(...new Uint8Array(hashBuffer)));
        }

        async function generateKeyPair() {
            const keyPair = await crypto.subtle.generateKey({ name: "ECDSA", namedCurve: "P-256" }, true, ["sign", "verify"]);
            const pubExport = await crypto.subtle.exportKey("spki", keyPair.publicKey);
            const privExport = await crypto.subtle.exportKey("pkcs8", keyPair.privateKey);
            return {
                pub: btoa(String.fromCharCode(...new Uint8Array(pubExport))),
                priv: btoa(String.fromCharCode(...new Uint8Array(privExport))),
                keyPair 
            };
        }

        async function importPrivateKey(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return await crypto.subtle.importKey("pkcs8", bytes.buffer, { name: "ECDSA", namedCurve: "P-256" }, true, ["sign"]);
        }

        async function signData(data, privateKey) {
            const signature = await crypto.subtle.sign({ name: "ECDSA", hash: { name: "SHA-256" } }, privateKey, new TextEncoder().encode(data));
            return btoa(String.fromCharCode(...new Uint8Array(signature)));
        }

        function saveState() {
            const data = { ...state };
            data.globalSeen = Array.from(state.globalSeen);
            data.nodes = state.nodes.map(n => ({...n, seenIds: Array.from(n.seenIds)}));
            localStorage.setItem('aob_v7_lab_state', JSON.stringify(data));
        }

        function loadState() {
            const saved = localStorage.getItem('aob_v7_lab_state');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...parsed, globalSeen: new Set(parsed.globalSeen || []) };
                state.nodes = state.nodes.map(n => ({...n, seenIds: new Set(n.seenIds || [])}));
                refreshUIFromState();
            } else {
                updateStepUI();
            }
        }

        function appendStatus(text) {
            const history = document.getElementById('status-history');
            const div = document.createElement('div');
            div.textContent = text;
            history.appendChild(div);
        }

        function updateStepUI() {
            const btns = [
                document.getElementById('btn-init-net'),
                document.getElementById('btn-init-users'),
                document.getElementById('btn-init-assets'),
                document.getElementById('btn-init-channels')
            ];
            btns.forEach((btn, i) => {
                if (i < state.step) {
                    btn.style.display = 'none';
                } else if (i === state.step) {
                    btn.disabled = false;
                    btn.classList.add('btn-active');
                    btn.classList.remove('btn-inactive');
                } else {
                    btn.disabled = true;
                    btn.classList.add('btn-inactive');
                    btn.classList.remove('btn-active');
                }
            });
        }

        function refreshUIFromState() {
            updateStepUI();
            if (state.nodes.length > 0) renderNodes();
            if (state.users.length > 0) renderUsers();
            if (state.chains.length > 0) renderChains();
            updateAllBalances();
            lucide.createIcons();
        }

        // --- Network Logic ---
        async function initNetwork() {
            appendStatus("建立 P2P 网络中...");
            state.nodes = Array.from({ length: CONFIG.NODE_COUNT }, () => ({
                id: crypto.randomUUID(),
                neighbors: [],
                logs: [],
                seenIds: new Set()
            }));

            state.nodes.forEach((node, i) => {
                const target = 4 + Math.floor(Math.random() * 2);
                while (node.neighbors.length < target) {
                    const peerIdx = Math.floor(Math.random() * state.nodes.length);
                    const peerId = state.nodes[peerIdx].id;
                    if (peerIdx !== i && !node.neighbors.includes(peerId)) {
                        node.neighbors.push(peerId);
                        state.nodes[peerIdx].neighbors.push(node.id);
                    }
                }
            });

            state.step = 1;
            appendStatus("网络就绪。");
            saveState();
            refreshUIFromState();
            switchTab('nodes');
        }

        async function initUsers() {
            appendStatus("创建加密用户账户...");
            superUser = await generateKeyPair(); 
            for (let i = 0; i < CONFIG.USER_COUNT; i++) {
                const u = await generateKeyPair();
                u.nodes = [
                    state.nodes[Math.floor(Math.random() * 10)].id,
                    state.nodes[10 + Math.floor(Math.random() * 10)].id,
                    state.nodes[20 + Math.floor(Math.random() * 10)].id
                ];
                state.users.push(u);
            }
            state.step = 2;
            appendStatus("用户账户就绪。");
            saveState();
            refreshUIFromState();
            switchTab('users');
        }

        async function initBanknotes() {
            appendStatus("依照 AOB 定义文件创建 100 条区块链...");
            if (!superUser) superUser = await generateKeyPair(); 
            const h = await getHash(CONFIG.DEFINITION_DOC);
            const k = superUser.pub;

            for (let s = 1; s <= CONFIG.BANKNOTE_COUNT; s++) {
                let den = 1;
                if (s > 20 && s <= 40) den = 5;
                else if (s > 40 && s <= 60) den = 10;
                else if (s > 60 && s <= 80) den = 20;
                else if (s > 80) den = 50;

                const gData = `${h}\n${s}\n${k}`;
                const gId = await getHash(gData);
                const genesis = { id: gId, type: 'GENESIS', data: gData, timestamp: Date.now() };

                const target = state.users[Math.floor(Math.random() * state.users.length)];
                const ts = Date.now();
                const pData = `${gId}\n支付区块\n${ts}\n${target.pub}`;
                const sig = await signData(pData, superUser.keyPair.privateKey);
                
                const pay = { id: sig, type: '支付区块', data: pData, prevId: gId, target: target.pub, timestamp: ts, signature: sig };

                state.chains.push({ serial: s, denomination: den, currentOwner: target.pub, genesisId: gId, blocks: [genesis, pay] });
                
                startBroadcast(genesis, state.nodes[0].id);
                startBroadcast(pay, state.nodes[0].id);
            }

            superUser = null; 
            state.step = 3;
            appendStatus("资产发行与分发就绪。");
            saveState();
            refreshUIFromState();
            switchTab('chains');
        }

        // --- Mesh Broadcast Simulation ---
        function startBroadcast(block, nodeId) {
            if (!state.globalSeen.has(block.id)) {
                state.globalSeen.add(block.id);
                db.get('messages').get(block.id).put({ json: JSON.stringify(block), entryNode: nodeId });
            }
            relayToNode(nodeId, block);
        }

        function relayToNode(nodeId, block) {
            const node = state.nodes.find(n => n.id === nodeId);
            if (!node || node.seenIds.has(block.id)) return;

            // 1. 记录广播消息
            node.seenIds.add(block.id);
            node.logs.unshift({ 
                id: block.id, 
                type: block.type, 
                time: new Date().toLocaleTimeString(),
                data: block.data || '(空内容)'
            });
            if (node.logs.length > 50) node.logs.pop();

            // 2. UI 视觉反馈与实时刷新详情页
            const el = document.getElementById(`node-${node.id}`);
            if (el) {
                el.classList.remove('node-pulse');
                void el.offsetWidth;
                el.classList.add('node-pulse');
            }
            
            if (activeOverlayId === node.id) {
                const logsContainer = document.getElementById('node-logs-container');
                if (logsContainer) logsContainer.innerHTML = renderNodeLogs(node);
            }

            // 3. 递归传播
            node.neighbors.forEach(neighborId => {
                setTimeout(() => relayToNode(neighborId, block), 50 + Math.random() * 150);
            });
        }

        db.get('messages').map().on((data, id) => {
            if (!data || state.globalSeen.has(id)) return;
            const block = JSON.parse(data.json);
            state.globalSeen.add(id);

            if (block.type === '支付区块') {
                const chain = state.chains.find(c => c.blocks.some(b => b.id === block.prevId));
                if (chain && !chain.blocks.find(b => b.id === block.id)) {
                    chain.blocks.push(block);
                    chain.currentOwner = block.target;
                    renderChains();
                    updateAllBalances();
                }
            }
            
            // 如果本地节点集不为空，通过一个合适的本地节点进入 Mesh 传播
            if (state.nodes.length > 0) {
                const entryNodeId = state.nodes.find(n => n.id === data.entryNode) ? data.entryNode : state.nodes[0].id;
                relayToNode(entryNodeId, block);
            }
        });

        // --- Rendering ---
        function renderNodeLogs(node) {
            return node.logs.map(l => `
                <div class="log-entry p-3 border border-slate-100 rounded-lg mono text-[8px] flex flex-col gap-1.5 animate-in fade-in slide-in-from-left-2">
                    <div class="flex justify-between items-center">
                        <span class="text-indigo-600 font-bold uppercase">${l.type}</span>
                        <span class="text-slate-300 shrink-0">${l.time}</span>
                    </div>
                    <div class="text-[7px] text-slate-400 truncate opacity-50">ID: ${l.id}</div>
                    <div class="text-[9px] text-slate-700 break-all bg-slate-50 p-2 rounded-md border border-slate-200 whitespace-pre-wrap leading-tight shadow-inner">${l.data}</div>
                </div>
            `).join('') || '<div class="text-xs text-slate-300 italic py-4 text-center">暂无记录</div>';
        }

        function renderNodes() {
            const grid = document.getElementById('node-grid');
            grid.innerHTML = '';
            state.nodes.forEach(n => {
                const el = document.createElement('div');
                el.id = `node-${n.id}`;
                el.className = 'card flex flex-col items-center justify-center p-6 space-y-2';
                el.setAttribute('onclick', `openNodeOverlay('${n.id}')`);
                el.innerHTML = `
                    <div class="text-[10px] font-black mono text-indigo-500 truncate w-full text-center select-none">${n.id.substring(0,8)}</div>
                    <div class="text-[9px] text-slate-400 uppercase font-bold flex items-center gap-1"><i data-lucide="link-2" size="10"></i> ${n.neighbors.length} PEERS</div>
                `;
                grid.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderUsers() {
            const grid = document.getElementById('user-grid');
            grid.innerHTML = '';
            state.users.forEach(u => {
                const el = document.createElement('div');
                el.className = 'card flex flex-col p-4 space-y-3';
                el.setAttribute('onclick', `openUserOverlay('${u.pub}')`);
                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="user" size="14"></i></div>
                        <div id="user-bal-${u.pub}" class="text-xs font-black text-indigo-600">$0</div>
                    </div>
                    <div>
                        <div class="text-[8px] text-slate-400 uppercase font-bold tracking-widest mb-1">公钥</div>
                        <div class="mono text-[10px] text-slate-900 truncate" title="${u.pub}">${u.pub.substring(0, 8)}...</div>
                    </div>
                `;
                grid.appendChild(el);
            });
            lucide.createIcons();
        }

        function renderChains() {
            const grid = document.getElementById('chain-grid');
            grid.innerHTML = '';
            state.chains.forEach(c => {
                const el = document.createElement('div');
                el.id = `chain-card-${c.genesisId}`;
                el.className = 'card flex flex-col items-center justify-center py-5 space-y-1';
                el.setAttribute('onclick', `openChainOverlay('${c.genesisId}')`);
                const lastId = c.blocks[c.blocks.length - 1].id;
                el.innerHTML = `
                    <div class="text-sm font-black text-emerald-600">$${c.denomination}</div>
                    <div class="mono text-[8px] text-slate-400 font-bold" title="${lastId}">#${c.serial} · ${lastId.substring(0,8)}</div>
                `;
                grid.appendChild(el);
            });
            lucide.createIcons();
        }

        function updateAllBalances() {
            state.users.forEach(u => {
                const bal = state.chains.filter(c => c.currentOwner === u.pub).reduce((s, c) => s + c.denomination, 0);
                const el = document.getElementById(`user-bal-${u.pub}`);
                if (el) el.innerText = `$${bal}`;
            });
        }

        // --- Navigation ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('border-indigo-600', 'text-indigo-600');
                b.classList.add('border-transparent', 'text-slate-400');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');
            const btn = document.getElementById(`tab-btn-${tabId}`);
            btn.classList.remove('border-transparent', 'text-slate-400');
            btn.classList.add('border-indigo-600', 'text-indigo-600');
        }

        function closeOverlay() {
            activeOverlayId = null;
            document.getElementById('overlay').classList.add('opacity-0', 'pointer-events-none');
            document.getElementById('overlay-content').classList.add('translate-x-full');
        }

        function openOverlay(title) {
            document.getElementById('overlay-title').innerText = title;
            document.getElementById('overlay').classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById('overlay-content').classList.remove('translate-x-full');
        }

        function openNodeOverlay(id) {
            activeOverlayId = id;
            const node = state.nodes.find(n => n.id === id);
            openOverlay(`节点控制台: ${node.id.substring(0,8)}`);
            const body = document.getElementById('overlay-body');
            const nodeUsers = state.users.filter(u => u.nodes.includes(id));
            body.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="text-[10px] text-slate-400 font-bold mb-1 uppercase">邻居连接</div>
                        <div class="mono text-[9px] break-all text-slate-600">${node.neighbors.map(n=>n.substring(0,6)).join(', ')}</div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-xl">
                        <div class="text-[10px] text-slate-400 font-bold mb-1 uppercase">本地用户数</div>
                        <div class="mono text-[10px] font-bold text-slate-600">${nodeUsers.length}</div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xs font-black uppercase text-slate-400 flex items-center justify-between px-1">广播流水 (全量显示) <span>${node.logs.length} 条</span></h3>
                    <div id="node-logs-container" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                        ${renderNodeLogs(node)}
                    </div>
                </div>
                <div class="p-6 bg-slate-900 rounded-2xl space-y-4 shadow-xl">
                    <h3 class="text-xs font-black text-indigo-400 uppercase tracking-wider">Mesh 网络广播测试</h3>
                    <textarea id="test-msg" class="w-full bg-slate-800 border-none rounded-xl p-4 text-xs text-white mono outline-none h-24 placeholder:text-slate-600 focus:ring-1 focus:ring-indigo-500 transition-all" placeholder="在此输入需要广播的完整数据内容..."></textarea>
                    <button onclick="broadcastTest('${node.id}')" class="w-full py-4 bg-indigo-600 text-white font-black rounded-xl text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-900/40">发起全网异步广播</button>
                </div>
            `;
            lucide.createIcons();
        }

        function broadcastTest(nodeId) {
            const val = document.getElementById('test-msg').value;
            if (!val) return;
            const block = { 
                id: 'TEST-' + Math.random().toString(36).substr(2, 12).toUpperCase(), 
                type: 'TEST_DATA', 
                data: val, 
                timestamp: Date.now() 
            };
            startBroadcast(block, nodeId);
            document.getElementById('test-msg').value = '';
        }

        function openUserOverlay(pub) {
            const user = state.users.find(u => u.pub === pub);
            const userChains = state.chains.filter(c => c.currentOwner === pub);
            openOverlay(`用户详情`);
            const body = document.getElementById('overlay-body');
            body.innerHTML = `
                <div class="p-8 bg-indigo-600 rounded-3xl text-white space-y-4 shadow-xl shadow-indigo-200">
                    <div>
                        <div class="text-[10px] opacity-60 font-bold uppercase tracking-widest">账户总额</div>
                        <div class="text-5xl font-black">$${userChains.reduce((s, c) => s + c.denomination, 0)}</div>
                    </div>
                    <div>
                        <div class="text-[10px] opacity-60 font-bold uppercase tracking-widest">Base64 公钥 ID</div>
                        <div class="mono text-[9px] break-all bg-white/10 p-4 rounded-xl mt-2 select-all leading-relaxed">${user.pub}</div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xs font-black uppercase text-slate-400">Mesh 接入节点</h3>
                    <div class="flex flex-wrap gap-2">
                        ${user.nodes.map(n => `<span class="px-3 py-1.5 bg-slate-100 rounded-lg mono text-[9px] font-bold text-slate-600">${n.substring(0,12)}...</span>`).join('')}
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xs font-black uppercase text-slate-400">持有的原子区块链 (${userChains.length})</h3>
                    <div class="grid grid-cols-4 gap-2">
                        ${userChains.map(c => `<div onclick="openChainOverlay('${c.genesisId}')" class="p-2 border border-slate-100 rounded-lg text-center bg-white hover:border-indigo-500 transition-colors"><div class="text-xs font-bold text-indigo-600">$${c.denomination}</div><div class="text-[8px] text-slate-400 mono">#${c.serial}</div></div>`).join('')}
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function openChainOverlay(genesisId) {
            const chain = state.chains.find(c => c.genesisId === genesisId);
            openOverlay(`区块链详情 #${chain.serial}`);
            const body = document.getElementById('overlay-body');
            const others = state.users.filter(u => u.pub !== chain.currentOwner);
            const randomTarget = others[Math.floor(Math.random() * others.length)].pub;

            body.innerHTML = `
                <div class="p-6 bg-emerald-50 rounded-2xl border border-emerald-100">
                    <div class="flex justify-between items-center mb-4">
                        <div class="px-3 py-1 bg-emerald-600 text-white text-[10px] font-bold rounded-full uppercase tracking-tighter">面值 $${chain.denomination}</div>
                        <div class="text-[10px] text-slate-400 font-bold mono">CHAIN-ROOT: ${chain.genesisId.substring(0, 10)}...</div>
                    </div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold mb-1">当前物权所有者 (PubKey)</div>
                    <div class="mono text-[9px] break-all p-3 bg-white rounded-xl border border-emerald-200 select-all leading-relaxed">${chain.currentOwner}</div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-black uppercase text-slate-400 px-1">原子账本区块历史</h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                        ${chain.blocks.map((b, i) => `
                            <div class="p-4 bg-white border border-slate-100 rounded-xl space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-[10px] font-black uppercase ${i===0?'text-indigo-600':'text-emerald-600'}">${b.type}</span>
                                    <span class="text-[9px] text-slate-300 mono">${new Date(b.timestamp).toLocaleTimeString()}</span>
                                </div>
                                <div class="mono text-[8px] text-slate-400 break-all bg-slate-50 p-2 rounded leading-tight">ID: ${b.id}</div>
                            </div>
                        `).reverse().join('')}
                    </div>
                </div>

                <div class="p-6 bg-slate-900 rounded-2xl space-y-4">
                    <h3 class="text-xs font-black text-indigo-400 uppercase">执行原子支付</h3>
                    <div>
                        <div class="text-[10px] text-slate-500 font-bold mb-2 uppercase">目标收款人 ID</div>
                        <select id="pay-target" class="w-full bg-slate-800 border-none rounded-xl p-4 text-[9px] text-white mono outline-none">
                            ${others.map(u => `<option value="${u.pub}" ${u.pub === randomTarget ? 'selected' : ''}>${u.pub.substring(0, 48)}...</option>`).join('')}
                        </select>
                    </div>
                    <button onclick="payBanknote('${chain.genesisId}')" class="w-full py-4 bg-indigo-600 text-white font-black rounded-xl text-sm hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-900/50">
                        签署并广播物权指令
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        async function payBanknote(genesisId) {
            const chain = state.chains.find(c => c.genesisId === genesisId);
            const targetPub = document.getElementById('pay-target').value;
            const currentUser = state.users.find(u => u.pub === chain.currentOwner);
            if (!currentUser) return alert("本地账户环境缺失。");

            appendStatus("执行 Web Crypto 数字签名...");
            const privKey = await importPrivateKey(currentUser.priv);
            const prev = chain.blocks[chain.blocks.length - 1];
            const ts = Date.now();
            const data = `${prev.id}\n支付区块\n${ts}\n${targetPub}`;
            const sig = await signData(data, privKey);

            const block = { id: sig, type: '支付区块', data: data, prevId: prev.id, target: targetPub, timestamp: ts, signature: sig };

            // 立即发起广播
            startBroadcast(block, currentUser.nodes[0]);
            
            appendStatus("支付区块已签署并进入 P2P 网络。");
            closeOverlay();
            saveState();
        }

        window.onload = loadState;
        lucide.createIcons();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>先进加密货币示范平台</title>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.run/@google/genai"
      }
    }
    </script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfcfd; color: #1e293b; overflow: hidden; height: 100vh; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .tab-content { display: none; height: calc(100vh - 280px); }
        .tab-content.active { display: flex; flex-direction: column; }
        
        .fixed-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: flex; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 100; }
        .fixed-overlay.open { opacity: 1; pointer-events: auto; }
        #details-overlay { justify-content: flex-end; }
        #details-content { width: 100%; max-width: 550px; height: 100%; background: white; box-shadow: -10px 0 30px rgba(0,0,0,0.1); transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        #details-overlay.open #details-content { transform: translateX(0); }

        .btn-box { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; border: 2px solid transparent; }
        .btn-active { background-color: #4f46e5; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); cursor: pointer; }
        .btn-inactive { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; opacity: 0.5; }
        
        .tab-btn { padding-top: 1rem; padding-bottom: 1rem; font-size: 0.875rem; font-weight: 700; border-bottom: 4px solid transparent; color: #94a3b8; transition: all 0.2s; }
        .tab-btn.active { border-bottom-color: #4f46e5; color: #4f46e5; }

        .card { background-color: white; border: 2px solid #e2e8f0; border-radius: 1rem; padding: 1rem; transition: all 0.2s; width: 12rem; flex-shrink: 0; cursor: pointer; position: relative; }
        .card:hover { border-color: #4f46e5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        .chain-local { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .chain-remote { border-color: #f59e0b !important; background-color: #fffbeb !important; }
        .chain-mortgaged { border-color: #94a3b8 !important; border-style: dashed !important; opacity: 0.6; filter: grayscale(1); }

        #network-svg { width: 100%; height: 100%; background: #fff; }
        .node { stroke: #fff; stroke-width: 3px; cursor: pointer; transition: fill 0.3s; }
        .link { stroke: #cbd5e1; stroke-opacity: 0.6; stroke-width: 1.5px; }
        
        /* 通道类型区分样式 */
        .chan-local { border-color: #4f46e5 !important; background-color: #f5f3ff !important; }
        .chan-hybrid { border-color: #10b981 !important; background-color: #f0fdf4 !important; }
        .chan-remote { border-color: #f59e0b !important; background-color: #fffbeb !important; }
        
        .participant-local { background-color: #4f46e5; color: white; padding: 0.1rem 0.3rem; border-radius: 0.25rem; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="bg-white border-b border-slate-200 p-8 z-30 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex justify-between items-start">
            <div class="space-y-2">
                <p class="text-xs font-black text-indigo-600 uppercase tracking-[0.3em]">Atomic Ownership TestNet</p>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter">先进加密货币示范平台</h1>
                <div id="status-line" class="text-sm text-slate-500 font-bold leading-relaxed flex flex-wrap items-center gap-3">
                    <span id="instruction-text">点击第一个按钮创建 P2P 网络节点。</span>
                    <div id="readiness-badges" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div id="mqtt-status" class="px-4 py-2 bg-amber-50 text-amber-600 text-[10px] font-black rounded-full uppercase border border-amber-100">Broker: Connecting...</div>
        </div>
        
        <div class="max-w-7xl mx-auto mt-8 flex flex-wrap gap-4 items-center" id="action-buttons">
            <button id="btn-init-net" onclick="window.initNetwork()" class="btn-box btn-active"><i data-lucide="network" size="18"></i> 创建网络</button>
            <button id="btn-init-accounts" onclick="window.initAccounts()" class="btn-box btn-inactive" disabled><i data-lucide="users" size="18"></i> 创建用户账户</button>
            <button id="btn-init-assets" onclick="window.initBanknotes()" class="btn-box btn-inactive" disabled><i data-lucide="banknote" size="18"></i> 创建区块链钞票</button>
            <button id="btn-init-channels" onclick="window.initChannels()" class="btn-box btn-inactive" disabled><i data-lucide="zap" size="18"></i> 创建快速通道</button>
        </div>
    </header>

    <nav class="bg-white border-b border-slate-100 px-8 flex-shrink-0">
        <div class="max-w-7xl mx-auto flex gap-10">
            <button onclick="window.switchTab('help')" id="tab-btn-help" class="tab-btn active flex items-center gap-2">使用指南 <i data-lucide="help-circle" size="16"></i></button>
            <button onclick="window.switchTab('nodes')" id="tab-btn-nodes" class="tab-btn flex items-center gap-2">网络节点 <i data-lucide="server" size="16"></i></button>
            <button onclick="window.switchTab('accounts')" id="tab-btn-accounts" class="tab-btn flex items-center gap-2">账户 <i data-lucide="user-square" size="16"></i></button>
            <button onclick="window.switchTab('chains')" id="tab-btn-chains" class="tab-btn flex items-center gap-2">区块链钞票 <i data-lucide="box" size="16"></i></button>
            <button onclick="window.switchTab('channels')" id="tab-btn-channels" class="tab-btn flex items-center gap-2">快速通道 <i data-lucide="zap" size="16"></i></button>
        </div>
    </nav>

    <main class="flex-grow bg-slate-50/50 relative overflow-hidden">
        <div id="tab-help" class="tab-content active p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-4xl mx-auto bg-white p-12 rounded-[3rem] shadow-xl space-y-8">
                <h2 class="text-3xl font-black text-slate-900 tracking-tighter">欢迎来到先进加密货币示范平台</h2>
                <div class="space-y-4 text-slate-600 leading-relaxed font-bold">
                    <div class="intro">
                        <p>这是一个真实运行的加密货币系统，也具备交互式教学功能。</p>
                        <p>在此,使用者能构建基于<span class="term">原子物权链(Atomic Ownership Blockchains, AOB)</span>实现的,全面优于通行技术的区块链货币创新架构。</p>
                    </div>

                    <h3>技术原理</h3>
                    <p>AOB 用微观的公域私有链构建货币系统,将每条区块链视为一张道具钞票,功能与纸钞票相似,通过变更钞票的归属记载用户资产的转移。</p>

                    <div class="advantages">
                        <h3>与通行技术相比有三方面优势:</h3>
                        <ul>
                            <li><strong>高于比特币的去中心化</strong>,支付无须矿工配合,达到无中心水平。</li>
                            <li><strong>密码学水平的安全</strong>,不依赖经济学幻想,能直接对抗双花攻击。</li>
                            <li><strong>无上限的性能和容量</strong>。</li>
                        </ul>
                    </div>

                    <h2>使用步骤</h2>
                    <p>使用者依次执行下面步骤:</p>

                    <ol>
                        <li>
                            <strong>连接网络</strong><br>
                            打开页面后,看右上角的联网标识,变为<span class="highlight">绿色</span>后表示 P2P 网络可用。
                        </li>

                        <li>
                            <strong>创建网络节点</strong><br>
                            点四个按钮中最左侧的<span class="highlight">"创建网络"</span>,创建 30 个节点。
                            <div class="note">
                                这些节点虽然是在同一网页进程中创建,彼此并不能直接访问,而是各自连接到 P2P 网络,所有数据交换都通过 P2P 网络协议实现。如果同时在另一个浏览器上打开本网页并创建网络,两边的节点可以连接在一起。从网络图中可以看到,<span class="term">蓝色节点</span>是本地的,<span class="term">黄色</span>是远端的。
                            </div>
                            点每个节点可以打开节点详情页。在详情页可以测试广播消息,广播后可在任一节点(包括远端节点)的详情页中看到消息的广播记录。
                        </li>

                        <li>
                            <strong>创建账户</strong><br>
                            点<span class="highlight">"创建账户"</span>按钮,创建 10 个账户。<br>
                            每个账户各有公私密钥,关联三个节点。<br>
                            点每个账户可打开详情页。
                        </li>

                        <li>
                            <strong>创建区块链</strong><br>
                            点<span class="highlight">"创建区块链"</span>按钮,创建 100 条区块链,表示 100 张道具钞票,每种面值 20 张。<br>
                            点每个区块链可打开详情页。在详情页中可以看到区块链中的区块,选择另一个账户(可以是远端账户)并支付,可添加并广播一个支付区块,将此区块链钞票发送到目标账户。
                        </li>

                        <li>
                            <strong>创建快速通道</strong><br>
                            点<span class="highlight">"创建快速通道"</span>按钮,可在相邻节点的每两个账户之间建立快速通道,并令每个通道中的两个账户各自向通道抵押部分区块链钞票。
                            <div class="note">
                                通道的两个账户可能都是本地的,都是远端的,或者有一个本地的。用三种颜色区分。
                            </div>
                            点每个快速通道可打开详情页。在详情页中可以将一个账户的余额之内的任意数值的金额支付给另一账户。类似闪电网络,这种支付方式无须广播到全网,比钞票式支付更加方便。也可通过级联通道将金额支付给无直接通道相连的账户。
                        </li>
                    </ol>
                </div>
            </div>
        </div>
        <div id="tab-nodes" class="tab-content overflow-hidden">
            <div class="flex-1 bg-white relative"><svg id="network-svg"></svg></div>
        </div>
        <div id="tab-accounts" class="tab-content p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-7xl mx-auto">
                <div id="account-grid-local" class="flex flex-wrap gap-6 mb-12"></div>
                <div id="account-grid-remote" class="flex flex-wrap gap-6"></div>
            </div>
        </div>
        <div id="tab-chains" class="tab-content p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-7xl mx-auto"><div id="chain-grid" class="flex flex-wrap gap-6"></div></div>
        </div>
        <div id="tab-channels" class="tab-content p-10 overflow-y-auto custom-scrollbar">
            <div class="max-w-7xl mx-auto"><div id="channel-grid" class="flex flex-wrap gap-6"></div></div>
        </div>
    </main>

    <div id="details-overlay" class="fixed-overlay" onclick="if(event.target==this) window.closeOverlay()">
        <div id="details-content" onclick="event.stopPropagation()">
            <div class="p-10 border-b border-slate-100 flex justify-between items-center">
                <h2 id="overlay-title" class="text-2xl font-black text-slate-900 uppercase">详情</h2>
                <button onclick="window.closeOverlay()" class="p-3 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <div id="overlay-body" class="flex-1 overflow-y-auto custom-scrollbar p-10 space-y-8 pb-20"></div>
        </div>
    </div>

    <script>
        var mqttClient;
        var superUser = null;
        var appInstanceId = localStorage.getItem('aob_instance_id') || Math.random().toString(36).substr(2, 4).toUpperCase();
        localStorage.setItem('aob_instance_id', appInstanceId);

        var cascadeSession = { active: false, path: [], initiatorIdx: 0 }; 
        var currentOpenedChannelId = null;

        var simulationState = { 
            nodes: [], users: [], remoteUsers: [], 
            chains: [], speedyChannels: [], step: 0,
            processedIds: new Set(),
            pendingMortgages: [],
            activeAmount: 10,
            readyFlags: [],
            instanceId: appInstanceId
        };

        const CONFIG = {
            NODE_COUNT: 30, ACCOUNT_COUNT: 10, BANKNOTE_COUNT: 100,
            MQTT_BROKER: 'ws://test.mosquitto.org:8080', 
            TOPIC_MESH: 'aob/v25/global_mesh', TOPIC_DISCOVERY: 'aob/v25/discovery', TOPIC_P2P: 'aob/v25/p2p',
            DEFINITION_TEXT: "Define each blockchain as a prop bill, with the data structure of its genesis block as: H\\nS\\nK, where: H is the SHA256 hash of this document (Base64); K is the public key of the system user (Base64), fixed at [系统账户的公钥]; S is the serial number, with the following correspondence to the banknote's denomination:\n1-20 1\n21-40 5\n41-60 10\n61-80 20\n81-100 50"
        };

        // --- Persistence ---
        function getLocal(key) { const d = localStorage.getItem(key); return d ? JSON.parse(d) : null; }
        function setLocal(key, v) { localStorage.setItem(key, JSON.stringify(v)); }

        async function saveFullState() {
            const data = {
                nodes: simulationState.nodes.map(n => ({ ...n, ledger: undefined, seenIds: undefined, logs: n.logs.slice(0, 50) })),
                users: await Promise.all(simulationState.users.map(async u => {
                    const jwk = await crypto.subtle.exportKey("jwk", u.keyPair.privateKey);
                    return { ...u, jwk, keyPair: undefined };
                })),
                chains: simulationState.chains,
                speedyChannels: simulationState.speedyChannels,
                superUserJwk: superUser ? await crypto.subtle.exportKey("jwk", superUser.keyPair.privateKey) : null,
                superUserPub: simulationState.superUserPub,
                step: simulationState.step,
                readyFlags: simulationState.readyFlags,
                instanceId: simulationState.instanceId,
                remoteUsers: simulationState.remoteUsers
            };
            setLocal('aob_lab_v9', data);
        }

        // --- Crypto ---
        async function getHash(text) { const hb = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text)); return btoa(String.fromCharCode(...new Uint8Array(hb))); }
        async function generateKeyPair() { const kp = await crypto.subtle.generateKey({ name: "ECDSA", namedCurve: "P-256" }, true, ["sign", "verify"]); const rp = await crypto.subtle.exportKey("raw", kp.publicKey); const p = btoa(String.fromCharCode(...new Uint8Array(rp))); return { pub: p, fp: p.slice(0, 8), keyPair: kp }; }
        async function signData(d, pk) { const s = await crypto.subtle.sign({ name: "ECDSA", hash: { name: "SHA-256" } }, pk, new TextEncoder().encode(d)); return btoa(String.fromCharCode(...new Uint8Array(s))); }

        // --- Network Layer ---
        window.initNetwork = async function() {
            const saved = getLocal('aob_lab_v9');
            if (saved && saved.nodes && saved.nodes.length > 0) {
                simulationState.nodes = saved.nodes.map(n => ({ ...n, ledger: {}, seenIds: new Set(), logs: n.logs || [] }));
                simulationState.instanceId = saved.instanceId;
                appInstanceId = saved.instanceId;
            } else {
                const locals = Array.from({ length: CONFIG.NODE_COUNT }, (_, i) => ({
                    id: `NODE-${appInstanceId}-${i}`, instance: appInstanceId, neighbors: [], logs: [], seenIds: new Set(), ledger: {}
                }));
                locals.forEach(n => {
                    while (n.neighbors.length < 4) {
                        const t = locals[Math.floor(Math.random() * locals.length)];
                        if (t.id !== n.id && !n.neighbors.includes(t.id) && t.neighbors.length < 7) {
                            n.neighbors.push(t.id); t.neighbors.push(n.id);
                        }
                        if (locals.every(an => an.neighbors.length >= 7 || an.id === n.id)) break;
                    }
                });
                simulationState.nodes = locals;
            }

            simulationState.nodes.filter(n => n.instance === appInstanceId).forEach(n => mqttClient.subscribe(`${CONFIG.TOPIC_P2P}/${n.id}`));
            initNetworkViz();
            setInterval(() => {
                simulationState.nodes.filter(n => n.instance === appInstanceId).forEach(n => {
                    mqttClient.publish(CONFIG.TOPIC_DISCOVERY, JSON.stringify({ type: 'HELLO', id: n.id, instance: appInstanceId }));
                    if (n.neighbors.length < 4) relayToNeighbors(n, { type: 'GET_PEERS', requesterId: n.id, mId: Math.random().toString(36).substr(2, 9), originator: n.id });
                });
            }, 5000);

            simulationState.readyFlags = ["网络就绪"];
            simulationState.step = 1; updateStepUI(); window.switchTab('nodes');
            await saveFullState();
        };

        window.initAccounts = async function() {
            const saved = getLocal('aob_lab_v9');
            if (saved && saved.users && saved.users.length > 0) {
                simulationState.superUserPub = saved.superUserPub;
                const spriv = await crypto.subtle.importKey("jwk", saved.superUserJwk, { name: "ECDSA", namedCurve: "P-256" }, true, ["sign"]);
                superUser = { pub: saved.superUserPub, keyPair: { privateKey: spriv } };
                simulationState.users = await Promise.all(saved.users.map(async u => {
                    const priv = await crypto.subtle.importKey("jwk", u.jwk, { name: "ECDSA", namedCurve: "P-256" }, true, ["sign"]);
                    const pubKeyBytes = new Uint8Array(atob(u.pub).split("").map(c => c.charCodeAt(0)));
                    const pub = await crypto.subtle.importKey("raw", pubKeyBytes, { name: "ECDSA", namedCurve: "P-256" }, true, ["verify"]);
                    return { ...u, keyPair: { privateKey: priv, publicKey: pub } };
                }));
                simulationState.remoteUsers = saved.remoteUsers || [];
            } else {
                superUser = await generateKeyPair(); simulationState.superUserPub = superUser.pub;
                for (let i = 0; i < CONFIG.ACCOUNT_COUNT; i++) {
                    const kp = await generateKeyPair(); 
                    kp.nodes = [
                        simulationState.nodes[i % CONFIG.NODE_COUNT].id,
                        simulationState.nodes[(i + 5) % CONFIG.NODE_COUNT].id,
                        simulationState.nodes[(i + 10) % CONFIG.NODE_COUNT].id
                    ];
                    simulationState.users.push(kp);
                }
            }
            simulationState.readyFlags.push("用户账户就绪");
            simulationState.step = 2; updateStepUI(); window.switchTab('accounts');
            await saveFullState();
        };

        window.initBanknotes = async function() {
            const saved = getLocal('aob_lab_v9');
            if (saved && saved.chains && saved.chains.length > 0) {
                simulationState.chains = saved.chains;
            } else {
                const filledDef = CONFIG.DEFINITION_TEXT.replace("[系统账户的公钥]", superUser.pub);
                const h = await getHash(filledDef);
                for (let s = 1; s <= CONFIG.BANKNOTE_COUNT; s++) {
                    const gData = `${h}\n${s}\n${superUser.pub}`; 
                    const gId = await getHash(gData);
                    const genesis = { id: gId, type: 'GENESIS', data: gData, author: superUser.pub, chainRootId: gId };
                    const target = simulationState.users[Math.floor(Math.random() * simulationState.users.length)];
                    const ts = Date.now();
                    const payData = `PREV:${gId}\nTYPE:PAYMENT\nTARGET:${target.pub}\nTS:${ts}`;
                    const sig = await signData(payData, superUser.keyPair.privateKey);
                    const payment = { id: sig, type: 'PAYMENT', data: payData, author: superUser.pub, target: target.pub, chainRootId: gId, sig };
                    await updateGlobalState(genesis); await updateGlobalState(payment);
                    mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block: genesis }));
                    mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block: payment }));
                }
            }
            simulationState.readyFlags.push("区块链钞票就绪");
            simulationState.step = 3; updateStepUI(); window.switchTab('chains');
            await saveFullState();
        };

        window.initChannels = async function() {
            const saved = getLocal('aob_lab_v9');
            if (saved && saved.speedyChannels && saved.speedyChannels.length > 0) {
                simulationState.speedyChannels = saved.speedyChannels;
            } else {
                const users = simulationState.users;
                const remotes = simulationState.remoteUsers;
                // 多轮尝试以满足 4 条通道的密度
                for (let round = 0; round < 20; round++) {
                    for (let i = 0; i < users.length; i++) {
                        let curCount = simulationState.speedyChannels.filter(c => c.participants.some(p => p.pub === users[i].pub)).length;
                        if (curCount >= 4) continue;
                        
                        let pool = [...users.filter(u=>u.pub !== users[i].pub).map(u=>u.pub), ...remotes];
                        pool.sort(() => Math.random() - 0.5);
                        for (let targetPub of pool) {
                            const u2 = users.find(u => u.pub === targetPub) || { pub: targetPub, nodes: ['REMOTE-NODE'] };
                            const sorted = [users[i].pub, targetPub].sort();
                            if (!simulationState.speedyChannels.find(c => c.participants[0].pub === sorted[0] && c.participants[1].pub === sorted[1])) {
                                await createAndBroadcastChannel(users[i], u2);
                                if (++curCount >= 4) break;
                            }
                        }
                    }
                }
            }
            simulationState.readyFlags.push("快速通道就绪");
            simulationState.step = 4; updateStepUI(); window.switchTab('channels');
            await saveFullState();
        };

        async function createAndBroadcastChannel(u1, u2) {
            const sorted = [u1.pub, u2.pub].sort();
            const rootData = `Speedy Channel\n${Date.now()}\n${sorted[0]}\n${u1.nodes ? u1.nodes[0] : 'UNK'}\n${sorted[1]}\n${u2.nodes ? u2.nodes[0] : 'UNK'}`;
            const cId = await getHash(rootData); 
            if (!simulationState.speedyChannels.find(x => x.id === cId)) {
                const block = { id: cId, type: 'SPEEDY_CHANNEL_ROOT', data: rootData, author: u1.pub, chainRootId: cId };
                await updateGlobalState(block);
                mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block }));
                
                [u1, u2].forEach(async u => {
                    const localUser = simulationState.users.find(lu => lu.pub === u.pub);
                    if (localUser && localUser.keyPair) {
                        const chains = simulationState.chains.filter(c => c.currentOwner === u.pub && c.status === 'FREE').sort((a, b) => b.denomination - a.denomination);
                        if(chains[0]) {
                            const mData = `PREV:${chains[0].blocks[chains[0].blocks.length-1].id}\nTYPE:MORTGAGE\nTARGET:${cId}\nTS:${Date.now()}`;
                            const sig = await signData(mData, localUser.keyPair.privateKey);
                            const mBlock = { id: sig, type: 'MORTGAGE', data: mData, author: u.pub, target: cId, chainRootId: chains[0].genesisId, sig };
                            await updateGlobalState(mBlock);
                            mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block: mBlock }));
                        }
                    }
                });
            }
            return cId;
        }

        async function updateGlobalState(block) {
            if (simulationState.processedIds.has(block.id)) return;
            simulationState.processedIds.add(block.id);

            simulationState.nodes.filter(n => n.instance === appInstanceId).forEach(n => {
                n.seenIds.add(block.id);
                const entry = `[区块同步] 类型:${block.type}\nID:${block.id.slice(0,16)}...\n作者:${block.author.slice(0,8)}...\n内容: ${block.data}`;
                n.logs.unshift({ time: new Date().toLocaleTimeString(), type: block.type, data: entry });
                if(n.logs.length > 50) n.logs.pop();
            });

            [block.author, block.target].forEach(p => {
                if (p && !simulationState.users.find(u => u.pub === p) && !simulationState.remoteUsers.includes(p)) simulationState.remoteUsers.push(p);
            });

            let c = simulationState.chains.find(x => x.genesisId === block.chainRootId);
            if (block.type === 'GENESIS' && !c) {
                const parts = block.data.split('\n'); const s = +parts[1]; 
                let d = 1; if(s>80) d=50; else if(s>60) d=20; else if(s>40) d=10; else if(s>20) d=5;
                c = { serial: s, denomination: d, genesisId: block.id, blocks: [block], currentOwner: 'SYSTEM', status: 'FREE' };
                simulationState.chains.push(c);
            } else if (c) {
                c.blocks.push(block);
                if (block.type === 'PAYMENT') { c.currentOwner = block.target; c.status = 'FREE'; }
                else if (block.type === 'MORTGAGE') {
                    c.status = 'MORTGAGED'; c.currentOwner = block.target;
                    const ch = simulationState.speedyChannels.find(x=>x.id===block.target);
                    if(ch) {
                        const p = ch.participants.find(p=>p.pub===block.author);
                        if(p) p.balance += c.denomination;
                    } else { simulationState.pendingMortgages.push({ target: block.target, author: block.author, value: c.denomination, genesisId: c.genesisId }); }
                }
            }

            if (block.type === 'SPEEDY_CHANNEL_ROOT' && !simulationState.speedyChannels.find(x => x.id === block.id)) {
                const l = block.data.split('\n');
                const chan = { id: block.id, participants: [{pub:l[2], fp:l[2].slice(0,8), balance:0, node:l[3]}, {pub:l[4], fp:l[4].slice(0,8), balance:0, node:l[5]}], history: [] };
                simulationState.speedyChannels.push(chan);
                simulationState.pendingMortgages = simulationState.pendingMortgages.filter(pm => {
                    if (pm.target === block.id) {
                        const p = chan.participants.find(p => p.pub === pm.author); if (p) p.balance += pm.value;
                        const chain = simulationState.chains.find(x => x.genesisId === pm.genesisId); if (chain) chain.currentOwner = block.id;
                        return false;
                    }
                    return true;
                });
            }
            window.renderAll();
        }

        function relayToNeighbors(node, payload) {
            node.neighbors.forEach(nbId => {
                if (mqttClient && mqttClient.connected) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ relay: { ...payload, fromNode: node.id, hop: 0 } }));
            });
        }

        function handleIncomingRelay(msg) {
            simulationState.nodes.filter(n => n.instance === appInstanceId).forEach(n => {
                if (!n.seenIds.has(msg.mId)) {
                    if (n.neighbors.includes(msg.fromNode) || msg.originator === n.id) {
                        n.seenIds.add(msg.mId);
                        const logEntry = `[${msg.type}] 来自者:${msg.originator}\n报文内容: ${msg.content || '节点状态广播'}\n消息ID: ${msg.mId}`;
                        n.logs.unshift({ time: new Date().toLocaleTimeString(), type: msg.type, data: logEntry });
                        if(n.logs.length > 50) n.logs.pop();
                        if (msg.hop < 4) mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ relay: { ...msg, fromNode: n.id, hop: msg.hop + 1 } }));
                    }
                }
            });
        }

        // --- UI ---
        window.switchTab = function(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${id}`).classList.add('active');
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('active'); if(b.id === `tab-btn-${id}`) b.classList.add('active'); });
            if(id === 'nodes' && simulation) updateNetworkViz();
            window.renderAll();
        };

        window.renderAll = function() {
            const lGrid = document.getElementById('account-grid-local'); if(lGrid) {
                lGrid.innerHTML = '';
                simulationState.users.forEach(u => {
                    const bal = simulationState.chains.filter(c => c.currentOwner === u.pub && c.status === 'FREE').reduce((s,c)=>s+c.denomination, 0);
                    const el = document.createElement('div'); el.className = 'card flex flex-col items-center gap-3 shadow-sm';
                    el.onclick = () => window.openAccountOverlay(u.pub);
                    el.innerHTML = `<div class="p-3 bg-indigo-50 rounded-full text-indigo-600"><i data-lucide="user"></i></div><div class="text-sm font-black text-slate-800">$${bal}</div><div class="text-[9px] mono text-slate-400 font-bold" title="${u.pub}">${u.fp}</div>`;
                    lGrid.appendChild(el);
                });
            }
            const rGrid = document.getElementById('account-grid-remote'); if(rGrid) {
                rGrid.innerHTML = '';
                simulationState.remoteUsers.forEach(pub => {
                    const el = document.createElement('div'); el.className = 'card flex flex-col items-center gap-3 opacity-60 grayscale scale-95';
                    el.onclick = () => window.openAccountOverlay(pub);
                    el.innerHTML = `<div class="p-3 bg-slate-100 rounded-full text-slate-400"><i data-lucide="user"></i></div><div class="text-[10px] font-bold text-slate-500 uppercase">Remote</div><div class="text-[9px] mono text-slate-300 font-bold" title="${pub}">${pub.slice(0,8)}</div>`;
                    rGrid.appendChild(el);
                });
            }
            const cGrid = document.getElementById('chain-grid'); if(cGrid) {
                cGrid.innerHTML = '';
                simulationState.chains.forEach(c => {
                    const isLocal = simulationState.users.some(u => u.pub === c.currentOwner);
                    const el = document.createElement('div');
                    let stateClass = c.status === 'MORTGAGED' ? "chain-mortgaged" : (isLocal ? "chain-local" : "chain-remote");
                    el.className = `card text-center ${stateClass}`;
                    el.onclick = () => window.openChainOverlay(c.genesisId);
                    el.innerHTML = `<div class="text-xl font-black chain-val">$${c.denomination}</div><div class="text-[9px] mono text-slate-500 font-bold mt-1 uppercase" title="${c.genesisId}">ID:${c.genesisId.slice(0,8)}</div>`;
                    cGrid.appendChild(el);
                });
            }
            const chGrid = document.getElementById('channel-grid'); if(chGrid) {
                chGrid.innerHTML = '';
                simulationState.speedyChannels.forEach(c => {
                    const isLocal1 = simulationState.users.some(u => u.pub === c.participants[0].pub);
                    const isLocal2 = simulationState.users.some(u => u.pub === c.participants[1].pub);
                    
                    let typeClass = "";
                    let typeLabel = "";
                    if (isLocal1 && isLocal2) { typeClass = "chan-local"; typeLabel = "LOCAL"; }
                    else if (isLocal1 || isLocal2) { typeClass = "chan-hybrid"; typeLabel = "HYBRID"; }
                    else { typeClass = "chan-remote"; typeLabel = "REMOTE"; }

                    const el = document.createElement('div'); el.className = `card ${typeClass}`;
                    el.onclick = () => window.openChannelOverlay(c.id);
                    el.innerHTML = `
                        <div class="text-[9px] font-black mb-2 uppercase tracking-tighter opacity-70">${typeLabel} CHANNEL</div>
                        <div class="flex justify-between items-center text-xs">
                            <div class="text-center font-bold">
                                <div>$${c.participants[0].balance}</div>
                                <div class="text-[8px] opacity-60 ${isLocal1?'participant-local':''}" title="${c.participants[0].pub}">${c.participants[0].fp}</div>
                            </div>
                            <i data-lucide="zap" class="opacity-40" size="14"></i>
                            <div class="text-center font-bold">
                                <div>$${c.participants[1].balance}</div>
                                <div class="text-[8px] opacity-60 ${isLocal2?'participant-local':''}" title="${c.participants[1].pub}">${c.participants[1].fp}</div>
                            </div>
                        </div>
                        <div class="text-[8px] mono opacity-40 mt-3 pt-2 border-t border-slate-100 truncate" title="${c.id}">ID: ${c.id.slice(0,16)}...</div>`;
                    chGrid.appendChild(el);
                });
            }
            if(window.lucide) lucide.createIcons();
            const badgeContainer = document.getElementById('readiness-badges');
            if (badgeContainer) badgeContainer.innerHTML = simulationState.readyFlags.map(f => `<span class="px-2 py-0.5 bg-indigo-50 text-indigo-600 rounded text-[10px] uppercase font-black tracking-widest border border-indigo-100">${f}</span>`).join('');
        };

        window.openNodeOverlay = function(id) {
            const n = simulationState.nodes.find(x => x.id === id); if(!n) return;
            const boundUsers = simulationState.users.filter(u => u.nodes && u.nodes.includes(id));
            window.openOverlay(`节点控制台: ${id}`);
            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6">
                    <div class="p-6 bg-slate-900 rounded-[2rem] text-white shadow-xl border-4 border-indigo-900/30">
                        <div class="text-[10px] uppercase font-black tracking-widest text-indigo-400 mb-3">本地账户 (${boundUsers.length})</div>
                        <div class="space-y-2 mb-4">
                            ${boundUsers.map(u => `<button onclick="window.openAccountOverlay('${u.pub}')" class="w-full text-left text-[9px] mono bg-indigo-500/10 px-3 py-2 rounded-lg border border-indigo-500/20 hover:bg-indigo-500/30 flex justify-between items-center"><span>${u.fp}...</span></button>`).join('') || '<div class="text-xs italic text-slate-500">无</div>'}
                        </div>
                        <div class="text-[10px] uppercase font-black tracking-widest text-indigo-400 mb-3">邻节点 (${n.neighbors.length})</div>
                        <div class="flex flex-wrap gap-2">${n.neighbors.map(nb => `<button onclick="window.openNodeOverlay('${nb}')" class="text-[9px] mono bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-indigo-500 transition-colors">${nb}</button>`).join('') || '<div class="text-xs italic text-slate-500">无</div>'}</div>
                    </div>
                    <div class="p-8 bg-indigo-50 border-2 border-indigo-100 rounded-[2rem] space-y-4 shadow-inner">
                        <h4 class="text-[10px] font-black uppercase text-indigo-600 tracking-widest flex items-center gap-2"><i data-lucide="radio" size="14"></i> 广播测试</h4>
                        <div class="flex gap-2"><input id="node-test-input" type="text" placeholder="输入测试报文..." class="flex-1 bg-white p-3 rounded-xl text-xs font-bold outline-none ring-1 ring-slate-200"><button onclick="window.broadcastTest('${id}')" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-[10px] uppercase shadow-md">广播</button></div>
                    </div>
                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">广播消息历史</h4>
                        <div class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">${n.logs.map(l => `<div class="p-4 border bg-white rounded-2xl flex flex-col gap-1 shadow-sm"><div class="flex justify-between items-center"><span class="text-[8px] font-black bg-slate-100 px-2 py-0.5 rounded text-slate-500 uppercase">${l.type}</span><span class="text-[8px] font-bold text-slate-400 mono">${l.time}</span></div><div class="text-[10px] font-bold text-slate-700 break-all leading-relaxed whitespace-pre-wrap">${l.data}</div></div>`).join('') || '<div class="text-xs text-slate-300 italic text-center py-8">暂无消息。</div>'}</div>
                    </div>
                </div>`;
            if(window.lucide) lucide.createIcons();
        };

        window.broadcastTest = (nid) => {
            const input = document.getElementById('node-test-input'); if(!input.value) return;
            const node = simulationState.nodes.find(x => x.id === nid);
            const mId = Math.random().toString(36).substr(2, 9);
            relayToNeighbors(node, { type: 'BROADCAST_TEST', content: input.value, originator: nid, mId });
            node.logs.unshift({ time: new Date().toLocaleTimeString(), type: 'BROADCAST_TEST', data: `[发起测试] 发起者:${nid}\n报文: ${input.value}\n消息ID: ${mId}` });
            input.value = ''; setTimeout(() => { if (!currentOpenedChannelId) window.openNodeOverlay(nid); }, 100);
        };

        window.openAccountOverlay = function(pub) {
            const isLocal = simulationState.users.some(u => u.pub === pub);
            const user = isLocal ? simulationState.users.find(u => u.pub === pub) : { pub };
            const ownedChains = simulationState.chains.filter(c => c.currentOwner === pub);
            const others = [...simulationState.users.filter(u=>u.pub!==pub).map(u=>u.pub), ...simulationState.remoteUsers.filter(u=>u!==pub)];

            window.openOverlay(isLocal ? "本地账户" : "远端账户");
            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6">
                    <div class="p-10 ${isLocal?'bg-indigo-600':'bg-slate-600'} text-white rounded-[2.5rem] text-center shadow-xl">
                        <div class="text-[10px] opacity-60 font-black tracking-widest mb-2 uppercase">资产</div>
                        <div class="text-6xl font-black">$${ownedChains.filter(c=>c.status==='FREE').reduce((s,c)=>s+c.denomination,0)}</div>
                        <div class="mt-6 text-[9px] mono opacity-60 break-all select-all font-bold" title="${pub}">${pub}</div>
                    </div>
                    ${isLocal ? `
                    <div class="p-8 bg-white border-2 border-indigo-50 rounded-[2.5rem] space-y-4 shadow-sm">
                        <h4 class="text-[10px] font-black uppercase text-indigo-600 tracking-widest">创建快速通道</h4>
                        <div class="flex flex-col gap-3">
                            <select id="manual-ch-target" class="w-full bg-slate-50 p-4 rounded-xl text-[10px] mono outline-none ring-1 ring-slate-200">
                                ${others.map(t => `<option value="${t}">${t.slice(0,16)}... (${simulationState.users.some(u=>u.pub===t)?'本地':'远端'})</option>`).join('')}
                            </select>
                            <button onclick="window.execManualChannel('${pub}')" class="bg-indigo-600 text-white py-4 rounded-xl font-black text-xs uppercase shadow-md active:scale-95">签署并建立通道</button>
                        </div>
                    </div>
                    ` : ''}
                    <div class="space-y-3">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">拥有的钞票 (${ownedChains.length})</h4>
                        <div class="grid grid-cols-2 gap-2">
                            ${ownedChains.map(c => `<button onclick="window.openChainOverlay('${c.genesisId}')" class="p-4 border-2 ${c.status==='FREE'?'border-indigo-50 hover:border-indigo-200':'border-slate-100 grayscale opacity-50'} bg-white rounded-2xl text-center"><div class="text-xl font-black text-slate-800">$${c.denomination}</div><div class="text-[8px] mono text-slate-400 font-bold uppercase mt-1" title="${c.genesisId}">ID:${c.genesisId.slice(0,8)}</div></button>`).join('') || '<div class="text-xs text-slate-300 italic py-4 text-center col-span-2">无资产</div>'}
                        </div>
                    </div>
                </div>`;
            if(window.lucide) lucide.createIcons();
        };

        window.execManualChannel = async function(localPub) {
            const targetPub = document.getElementById('manual-ch-target').value;
            const u1 = simulationState.users.find(u => u.pub === localPub);
            const u2 = simulationState.users.find(u => u.pub === targetPub) || { pub: targetPub, nodes: ['REMOTE-NODE'] };
            await createAndBroadcastChannel(u1, u2);
            window.closeOverlay();
            window.switchTab('channels');
            await saveFullState();
        };

        window.openChainOverlay = function(id) {
            const c = simulationState.chains.find(x => x.genesisId === id); if(!c) return;
            const isLocal = simulationState.users.some(u => u.pub === c.currentOwner);
            const others = [...simulationState.users.filter(u=>u.pub!==c.currentOwner).map(u=>u.pub), ...simulationState.remoteUsers.filter(u=>u!==c.currentOwner)];
            window.openOverlay(`钞票详情: ${id.slice(0,12)}`);
            document.getElementById('overlay-body').innerHTML = `<div class="space-y-6"><div class="p-10 bg-emerald-50 border-4 border-emerald-100 rounded-[3rem] text-center"><div class="text-7xl font-black text-emerald-600">$${c.denomination}</div><div class="text-[10px] font-black uppercase text-slate-400 mt-4 tracking-widest">状态: ${c.status}</div></div>${isLocal && c.status === 'FREE' ? `<div class="p-8 bg-white border-2 border-indigo-50 rounded-[2.5rem] space-y-5 shadow-lg"><h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">签署支付</h4><select id="pay-target-select" class="w-full bg-slate-50 p-4 rounded-xl text-[10px] mono outline-none ring-1 ring-slate-200">${others.map(t => `<option value="${t}">${t.slice(0,16)}...</option>`).join('')}</select><button onclick="window.execPayment('${id}')" class="w-full bg-indigo-600 text-white py-5 rounded-xl font-black uppercase text-xs shadow-xl active:scale-95">签署并广播变更</button></div>` : '<div class="p-10 text-center text-xs italic bg-slate-50 rounded-2xl">只读视图。</div>'}<div class="space-y-3"><h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">溯源历史</h4><div class="space-y-2">${c.blocks.map(b => `<div class="p-4 border bg-white rounded-2xl text-[10px] shadow-sm"><div class="flex justify-between font-black text-indigo-600 mb-1"><span>${b.type}</span><span class="mono" title="${b.id}">${b.id.slice(0,16)}...</span></div><div class="text-slate-500 mono break-all whitespace-pre-wrap">${b.data}</div></div>`).join('')}</div></div></div>`;
        };

        window.execPayment = async function(chainId) {
            const c = simulationState.chains.find(x => x.genesisId === chainId), target = document.getElementById('pay-target-select').value, owner = simulationState.users.find(u => u.pub === c.currentOwner);
            const data = `PREV:${c.blocks[c.blocks.length-1].id}\nTYPE:PAYMENT\nTARGET:${target}\nTS:${Date.now()}`;
            const sig = await signData(data, owner.keyPair.privateKey);
            const block = { id: sig, type: 'PAYMENT', data, author: c.currentOwner, target, chainRootId: chainId, sig };
            await updateGlobalState(block); mqttClient.publish(CONFIG.TOPIC_MESH, JSON.stringify({ block }));
            window.closeOverlay(); await saveFullState();
        };

        window.openChannelOverlay = function(id) { currentOpenedChannelId = id; cascadeSession = { active: false, path: [id], initiatorIdx: 0 }; window.refreshChannelUI(id); };
        window.refreshChannelUI = function(id) {
            const chan = simulationState.speedyChannels.find(x => x.id === id); if (!chan) return;
            const p1 = chan.participants[0], p2 = chan.participants[1], isP1Local = simulationState.users.some(u => u.pub === p1.pub), isP2Local = simulationState.users.some(u => u.pub === p2.pub);
            window.openOverlay(`快速通道详情`);
            document.getElementById('overlay-body').innerHTML = `
                <div class="space-y-6 pb-20">
                    <div class="p-12 bg-slate-900 rounded-[3.5rem] flex justify-between items-center text-white shadow-2xl border-4 border-indigo-900/30">
                        <div class="text-center flex-1">
                            <div class="text-5xl font-black">$${p1.balance}</div>
                            <div class="text-[9px] mono text-indigo-400 mt-2 font-bold ${isP1Local?'participant-local':''}" title="${p1.pub}">${p1.fp}</div>
                        </div>
                        <i data-lucide="zap" class="text-emerald-500 animate-pulse" size="40"></i>
                        <div class="text-center flex-1">
                            <div class="text-5xl font-black">$${p2.balance}</div>
                            <div class="text-[9px] mono text-indigo-400 mt-2 font-bold ${isP2Local?'participant-local':''}" title="${p2.pub}">${p2.fp}</div>
                        </div>
                    </div>
                    <div class="p-8 bg-white border-2 border-indigo-50 rounded-[2.5rem] space-y-6 shadow-lg">
                        <h4 class="text-[10px] font-black uppercase text-slate-400 tracking-widest">通道支付</h4>
                        <div class="flex gap-4">
                            <select id="ch-sender" class="flex-1 bg-slate-50 p-4 rounded-xl text-xs font-black outline-none">
                                <option value="0" ${!isP1Local ? 'disabled' : ''}>${p1.fp} 发送</option>
                                <option value="1" ${!isP2Local ? 'disabled' : ''}>${p2.fp} 发送</option>
                            </select>
                            <input id="ch-amt" type="number" oninput="simulationState.activeAmount = Number(this.value)" class="w-24 bg-slate-50 p-4 rounded-xl text-xs font-black outline-none" value="${simulationState.activeAmount}">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="window.execChPay('${id}')" class="bg-indigo-600 text-white py-4 rounded-xl font-black text-[10px] uppercase shadow-lg">直接支付</button>
                            <button onclick="window.startCascadeMode('${id}')" class="bg-indigo-50 text-indigo-600 py-4 rounded-xl font-black text-[10px] uppercase">开启级联</button>
                        </div>
                    </div>
                    <div id="cascade-builder" class="${cascadeSession.active ? '' : 'hidden'} p-8 bg-indigo-50 rounded-[2.5rem] space-y-4 shadow-inner border-2 border-indigo-100">
                        <h4 class="text-[11px] font-black uppercase text-indigo-600 tracking-widest">级联支付构建</h4>
                        <div id="cascade-steps" class="space-y-2"></div>
                        <div id="cascade-next" class="pt-4 border-t border-indigo-100"></div>
                        <button onclick="window.executeCascade()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black uppercase text-xs shadow-xl mt-4">在级联通道中支付</button>
                    </div>
                </div>`;
            if(window.lucide) lucide.createIcons();
            if(cascadeSession.active) window.updateCascadeList();
        };

        window.startCascadeMode = (id) => { cascadeSession.active = true; cascadeSession.initiatorIdx = +document.getElementById('ch-sender').value; cascadeSession.path = [id]; window.refreshChannelUI(id); };
        window.updateCascadeList = () => {
            const stepsEl = document.getElementById('cascade-steps'), nextEl = document.getElementById('cascade-next'); if(!stepsEl) return;
            let curPub = simulationState.speedyChannels.find(x => x.id === cascadeSession.path[0]).participants[cascadeSession.initiatorIdx].pub;
            stepsEl.innerHTML = cascadeSession.path.map((cid, i) => {
                const chan = simulationState.speedyChannels.find(x => x.id === cid), sender = chan.participants.find(p => p.pub === curPub), receiver = chan.participants.find(p => p.pub !== curPub);
                curPub = receiver.pub;
                return `<div class="p-4 bg-white rounded-2xl text-[10px] border-2 border-indigo-100 flex flex-col gap-1 shadow-sm"><div class="flex justify-between font-black text-indigo-600 uppercase"><span>Hop #${i+1}</span><span class="mono">ID:${cid.slice(0,8)}</span></div><div class="flex items-center gap-2 mt-1"><span class="mono px-2 py-0.5 bg-indigo-50 rounded font-bold">${sender.fp}</span><i data-lucide="arrow-right" size="10" class="text-slate-300"></i><span class="mono px-2 py-0.5 bg-emerald-50 rounded font-bold">${receiver.fp}</span></div></div>`;
            }).join('');
            const currentParticipantPub = curPub;
            const others = simulationState.speedyChannels.filter(c => !cascadeSession.path.includes(c.id) && c.participants.some(p => p.pub === currentParticipantPub));
            nextEl.innerHTML = others.map(o => `<button onclick="window.addCascadeHop('${o.id}')" class="w-full bg-white p-4 rounded-2xl text-[10px] text-indigo-700 text-left border-2 border-dashed border-indigo-200 hover:border-indigo-400 transition-all flex justify-between items-center"><div><span class="font-black">经由通道 ${o.id.slice(0,8)}</span></div><i data-lucide="plus" size="14"></i></button>`).join('') || '<div class="text-xs italic text-slate-400 py-4">无后续可用路径。</div>';
            if(window.lucide) lucide.createIcons();
        };
        window.addCascadeHop = (id) => { cascadeSession.path.push(id); window.updateCascadeList(); };
        window.executeCascade = async () => {
            const amt = Number(simulationState.activeAmount); if (isNaN(amt) || amt <= 0) return;
            let curPub = simulationState.speedyChannels.find(x => x.id === cascadeSession.path[0]).participants[cascadeSession.initiatorIdx].pub;
            cascadeSession.path.forEach(cid => {
                const c = simulationState.speedyChannels.find(x => x.id === cid);
                const senderIdx = c.participants.findIndex(p => p.pub === curPub);
                const receiver = c.participants[senderIdx === 0 ? 1 : 0];
                mqttClient.publish(`${CONFIG.TOPIC_P2P}/${receiver.node}`, JSON.stringify({ type: 'SPEEDY_CHANNEL_UPDATE', msgId: Math.random().toString(36).substr(2, 9), channelId: cid, senderPub: curPub, amount: amt }));
                curPub = receiver.pub;
            });
            cascadeSession.active = false; window.closeOverlay(); await saveFullState();
        };

        window.execChPay = async function(id) {
            const c = simulationState.speedyChannels.find(x=>x.id===id), sIdx = +document.getElementById('ch-sender').value, amt = Number(simulationState.activeAmount);
            if (isNaN(amt) || amt <= 0 || c.participants[sIdx].balance < amt) return;
            const sender = c.participants[sIdx], receiver = c.participants[sIdx === 0 ? 1 : 0];
            mqttClient.publish(`${CONFIG.TOPIC_P2P}/${receiver.node}`, JSON.stringify({ type: 'SPEEDY_CHANNEL_UPDATE', msgId: Math.random().toString(36).substr(2, 9), channelId: id, senderPub: sender.pub, amount: amt }));
            await saveFullState();
        };

        window.openOverlay = (t) => { document.getElementById('overlay-title').innerText = t; document.getElementById('details-overlay').classList.add('open'); };
        window.closeOverlay = () => { currentOpenedChannelId = null; document.getElementById('details-overlay').classList.remove('open'); window.renderAll(); };
        
        // --- D3 Graph ---
        let simulation, svg, g;
        function initNetworkViz() {
            svg = d3.select("#network-svg"); if(!svg.node()) return;
            const container = svg.node().parentElement;
            const w = container.clientWidth, h = container.clientHeight;
            g = svg.append("g"); svg.call(d3.zoom().scaleExtent([0.1, 5]).on("zoom", (e) => g.attr("transform", e.transform)));
            simulation = d3.forceSimulation().force("link", d3.forceLink().id(d => d.id).distance(150)).force("charge", d3.forceManyBody().strength(-400)).force("center", d3.forceCenter(w / 2, h / 2));
            updateNetworkViz();
        }
        function updateNetworkViz() {
            if(!g) return;
            const container = document.getElementById('network-svg').parentElement;
            const w = container.clientWidth, h = container.clientHeight;
            const nodes = simulationState.nodes.map(n => ({ id: n.id, local: n.instance === appInstanceId }));
            const links = []; 
            simulationState.nodes.forEach(n => { n.neighbors.forEach(nbid => { if (n.id < nbid && simulationState.nodes.some(x => x.id === nbid)) links.push({ source: n.id, target: nbid }); }); });
            g.selectAll("*").remove();
            const link = g.append("g").selectAll("line").data(links).enter().append("line").attr("class", "link");
            const node = g.append("g").selectAll("circle").data(nodes).enter().append("circle").attr("r", 12).attr("fill", d => d.local ? "#4f46e5" : "#fb923c").attr("class", "node shadow-lg").on("click", (e, d) => window.openNodeOverlay(d.id));
            simulation.nodes(nodes); simulation.force("link").links(links); simulation.force("center", d3.forceCenter(w / 2, h / 2));
            simulation.alpha(1).restart();
            simulation.on("tick", () => { link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y); node.attr("cx", d => d.x).attr("cy", d => d.y); });
        }

        function updateStepUI() {
            const steps = [{ id: 'btn-init-net', index: 0 }, { id: 'btn-init-accounts', index: 1 }, { id: 'btn-init-assets', index: 2 }, { id: 'btn-init-channels', index: 3 }];
            steps.forEach(s => {
                const btn = document.getElementById(s.id); if (!btn) return;
                if (simulationState.step > s.index) { btn.remove(); } else {
                    btn.style.display = 'flex'; btn.disabled = (simulationState.step !== s.index);
                    if (simulationState.step === s.index) { btn.classList.add('btn-active'); btn.classList.remove('btn-inactive'); } else { btn.classList.add('btn-inactive'); btn.classList.remove('btn-active'); }
                }
            });
            const instr = document.getElementById('instruction-text');
            if(simulationState.step === 0) instr.innerText = "实验初始化：点击创建网络开始。";
            else if(simulationState.step === 4) instr.innerText = "快速通道就绪，可通过通道支付。";
            else instr.innerText = `网络就绪级别: ${simulationState.readyFlags.join(', ')}。请继续。`;
            window.renderAll();
        }

        mqttClient = mqtt.connect(CONFIG.MQTT_BROKER, { clientId: 'aob_v25_' + appInstanceId, clean: true });
        mqttClient.on('connect', () => { 
            mqttClient.subscribe(CONFIG.TOPIC_MESH); mqttClient.subscribe(CONFIG.TOPIC_DISCOVERY); 
            const s = document.getElementById('mqtt-status'); if(s) { s.innerText = "Broker: Online"; s.className = "px-4 py-2 bg-green-50 text-green-600 text-[10px] font-black rounded-full uppercase border border-green-100"; }
        });
        mqttClient.on('message', (t, p) => {
            try {
                const d = JSON.parse(p.toString());
                if (t === CONFIG.TOPIC_MESH) { if (d.relay) handleIncomingRelay(d.relay); else if (d.block) updateGlobalState(d.block); }
                else if (t === CONFIG.TOPIC_DISCOVERY) {
                    if (d.instance === appInstanceId) return;
                    let rNode = simulationState.nodes.find(x => x.id === d.id);
                    if (!rNode) { rNode = { id: d.id, instance: d.instance, neighbors: [], logs: [], seenIds: new Set(), ledger: {} }; simulationState.nodes.push(rNode); mqttClient.subscribe(`${CONFIG.TOPIC_P2P}/${rNode.id}`); }
                    if (d.type === 'HELLO') {
                        const locals = simulationState.nodes.filter(n => n.instance === appInstanceId && n.neighbors.length < 7);
                        if(locals[0]) {
                            const ln = locals[Math.floor(Math.random()*locals.length)];
                            if(!ln.neighbors.includes(d.id)) { ln.neighbors.push(d.id); rNode.neighbors.push(ln.id); mqttClient.publish(CONFIG.TOPIC_DISCOVERY, JSON.stringify({ type: 'HELLO_BACK', id: ln.id, targetId: d.id, instance: appInstanceId })); }
                        }
                    }
                    if(simulation) updateNetworkViz();
                } else if (t.startsWith(CONFIG.TOPIC_P2P)) {
                    if (d.type === 'SPEEDY_CHANNEL_UPDATE') {
                        const c = simulationState.speedyChannels.find(x => x.id === d.channelId);
                        if (c && !simulationState.processedIds.has(d.msgId)) {
                            simulationState.processedIds.add(d.msgId);
                            const sIdx = c.participants.findIndex(p => p.pub === d.senderPub);
                            if (sIdx !== -1) {
                                c.participants[sIdx].balance -= d.amount;
                                c.participants[sIdx === 0 ? 1 : 0].balance += d.amount;
                                window.renderAll(); if (currentOpenedChannelId === d.channelId) window.refreshChannelUI(d.channelId);
                            }
                        }
                    }
                }
            } catch (e) {}
        });

        document.addEventListener('DOMContentLoaded', () => { updateStepUI(); });
    </script>
</body>
</html>